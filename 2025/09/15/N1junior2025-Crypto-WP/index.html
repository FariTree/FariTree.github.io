<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="mask-icon" href="/images/Default_Emote-Thumbs_Up.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"faritree.top","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":2,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="article">
<meta property="og:title" content="N1junior2025-Crypto-WP">
<meta property="og:url" content="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/index.html">
<meta property="og:site_name" content="FariTree&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/pic.jpg">
<meta property="article:published_time" content="2025-09-15T04:21:06.000Z">
<meta property="article:modified_time" content="2025-10-17T11:05:07.453Z">
<meta property="article:author" content="FariTree">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/pic.jpg">


<link rel="canonical" href="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/","path":"2025/09/15/N1junior2025-Crypto-WP/","title":"N1junior2025-Crypto-WP"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>N1junior2025-Crypto-WP | FariTree's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">FariTree's Blog</p>
      <i class="logo-line"></i>
    </a>
      <img class="custom-logo-image" src="/images/Default_Emote-Thumbs_Up.png" alt="FariTree's Blog">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#sign-in-the-ca7s"><span class="nav-number">1.</span> <span class="nav-text">sign in the ca7s</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="nav-number">1.1.</span> <span class="nav-text">è§£é¢˜æ€è·¯</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#level-1-0"><span class="nav-number">1.1.1.</span> <span class="nav-text">level 1 &amp; 0</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#level-2"><span class="nav-number">1.1.2.</span> <span class="nav-text">level 2</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp"><span class="nav-number">1.2.</span> <span class="nav-text">Exp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%9B%E5%90%8E%E8%AE%A8%E8%AE%BA"><span class="nav-number">1.3.</span> <span class="nav-text">èµ›åè®¨è®º</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sign-the-ca7s"><span class="nav-number">2.</span> <span class="nav-text">sign the ca7s</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="nav-number">2.1.</span> <span class="nav-text">è§£é¢˜æ€è·¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-1"><span class="nav-number">2.2.</span> <span class="nav-text">Exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sign-one-m0re"><span class="nav-number">3.</span> <span class="nav-text">sign one m0re</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-2"><span class="nav-number">3.1.</span> <span class="nav-text">è§£é¢˜æ€è·¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-2"><span class="nav-number">3.2.</span> <span class="nav-text">Exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sm1%C2%BC"><span class="nav-number">4.</span> <span class="nav-text">SM1Â¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-3"><span class="nav-number">4.1.</span> <span class="nav-text">è§£é¢˜æ€è·¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-3"><span class="nav-number">4.2.</span> <span class="nav-text">Exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#references"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">FariTree</p>
  <div class="site-description" itemprop="description">å¥½é¥¿å•Šï¼Œæ—©çŸ¥é“ä¸å­¦cryptoäº†</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FariTree">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FariTree's Blog">
      <meta itemprop="description" content="å¥½é¥¿å•Šï¼Œæ—©çŸ¥é“ä¸å­¦cryptoäº†">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="N1junior2025-Crypto-WP | FariTree's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          N1junior2025-Crypto-WP
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-15 12:21:06" itemprop="dateCreated datePublished" datetime="2025-09-15T12:21:06+08:00">2025-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-17 19:05:07" itemprop="dateModified" datetime="2025-10-17T19:05:07+08:00">2025-10-17</time>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="/2025/09/15/N1junior2025-Crypto-WP/pic.jpg"></p>
<span id="more"></span>
<h3 id="sign-in-the-ca7s">sign in the ca7s</h3>
<p><strong>é¢˜ç›®æè¿°</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sign in the cats, so that you can cat the flag! ğŸ±</span><br><span class="line"></span><br><span class="line">Note: This is the easy version of &quot;sign the ca7s&quot;.</span><br></pre></td></tr></table></figure>
<p><strong>é¢˜ç›®é™„ä»¶</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.sage</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;**redacted**&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(GF(<span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span>), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).x()) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">pub, ctx, msg, sig</span>):</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r, s = sig</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n:</span><br><span class="line">        <span class="keyword">return</span> r == <span class="built_in">int</span>((<span class="built_in">pow</span>(s, -<span class="number">1</span>, n) * (z * G + r * pub)).x()) % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chall</span>(<span class="params">level, flag</span>):</span><br><span class="line">    priv = randint(<span class="number">1</span>, n - <span class="number">1</span>)</span><br><span class="line">    pub = priv * G</span><br><span class="line">    msg = os.urandom(<span class="number">64</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;=== level <span class="subst">&#123;level&#125;</span> ===&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(catalan_number(level)):</span><br><span class="line">        ctx = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&#x27;context: &#x27;</span>))</span><br><span class="line">        r, s = sign(priv, ctx, msg)</span><br><span class="line">        <span class="keyword">assert</span> verify(pub, ctx, msg, (r, s))</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">1</span>: <span class="built_in">print</span>(<span class="string">&#x27;message:&#x27;</span>, msg.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">2</span>: <span class="built_in">print</span>(<span class="string">&#x27;sign:&#x27;</span>, r)</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">3</span>: <span class="built_in">print</span>(<span class="string">&#x27;ature:&#x27;</span>, s)</span><br><span class="line">    </span><br><span class="line">    r, s = <span class="built_in">map</span>(<span class="built_in">int</span>, <span class="built_in">input</span>(<span class="string">&#x27;signature: &#x27;</span>).split())</span><br><span class="line">    <span class="keyword">assert</span> verify(pub, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode(), (r, s))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;flag<span class="subst">&#123;level&#125;</span>:&#x27;</span>, flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    chall(<span class="number">0</span>, <span class="string">&quot;ğŸ’§&quot;</span>)</span><br><span class="line">    chall(<span class="number">1</span>, <span class="string">&quot;ğŸ±&quot;</span>)</span><br><span class="line">    chall(<span class="number">2</span>, FLAG)</span><br></pre></td></tr></table></figure>
<h4 id="è§£é¢˜æ€è·¯">è§£é¢˜æ€è·¯</h4>
<h5 id="level-1-0">level 1 &amp; 0</h5>
<p>æ›²çº¿æ˜¯anomalousçš„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨SmartAttackæ±‚å‡º kï¼Œä½†æ˜¯è¿™é‡Œ k
çš„æ­£è´Ÿä¸æ¸…æ¥šï¼Œçˆ†å°±å®Œäº†ï¼Œç„¶å ctx å’Œ msg éƒ½çŸ¥é“ï¼Œæ‰€ä»¥ç›´æ¥æ±‚ç§é’¥å°±è¡Œã€‚</p>
<h5 id="level-2">level 2</h5>
<p>è¿™æ¬¡msgä¸çŸ¥é“äº†ï¼Œä½†æ˜¯æœ‰2å¯¹ç­¾åå€¼ã€‚</p>
<p>å¯ä»¥ç”¨ fastcoll ç”Ÿæˆ2ä¸ªmd5ä¸€æ ·çš„
ctxï¼Œç”±äºmd5æ˜¯ä»å‰å¾€åè¯»å–æ¶ˆæ¯å¹¶æ›´æ–°å†…éƒ¨hashå€¼çš„ï¼Œæ‰€ä»¥ä¸¤æ¬¡ md5(ctx +
msg) ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ · z
å°±æ˜¯ä¸€æ ·çš„ã€‚è¿™æ ·æœªçŸ¥æ•°å°±åªæœ‰zå’Œprivï¼Œåˆšå¥½æœ‰2ä¸ªç­¾åæ–¹ç¨‹ã€‚æ‹¿åˆ°ç§é’¥æ­£å¸¸ç­¾å°±è¡Œã€‚</p>
<h4 id="exp">Exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.sage</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote, context</span><br><span class="line"><span class="keyword">from</span> ctf_tools.crypto.ECC.SmartAttack <span class="keyword">import</span> SmartAttack</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span></span><br><span class="line">E = EllipticCurve(GF(p), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).x()) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">pub, ctx, msg, sig</span>):</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r, s = sig</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n:</span><br><span class="line">        <span class="keyword">return</span> r == <span class="built_in">int</span>((<span class="built_in">pow</span>(s, -<span class="number">1</span>, n) * (z * G + r * pub)).x()) % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">phi</span>(<span class="params">P</span>):</span><br><span class="line">    <span class="keyword">return</span> - P.x() / P.y()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">playonce</span>():</span><br><span class="line">    io = remote(<span class="string">&quot;60.205.163.215&quot;</span>, <span class="number">11776</span>)</span><br><span class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">        ctx = <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">        io.sendline(ctx.<span class="built_in">hex</span>().encode())</span><br><span class="line">        msg = <span class="built_in">bytes</span>.fromhex(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        r = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        s = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        k = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r)), p))</span><br><span class="line">        z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">        pri = (s * k - z) * <span class="built_in">pow</span>(r, -<span class="number">1</span>, n) % n</span><br><span class="line">        r, s = sign(pri, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">        io.sendline((<span class="built_in">str</span>(r) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(s)).encode())</span><br><span class="line">        recv = io.recvline().decode()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Traceback&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># generated by fastcoll</span></span><br><span class="line">    ctx1 = <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07&#x27;</span></span><br><span class="line">    ctx2 = <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7~&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5\xc1\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1a\xeeZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x0bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbb\xe3\x01\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa,\x93\xb0\x9d\x07&#x27;</span></span><br><span class="line">    CTX = [ctx1, ctx2]</span><br><span class="line">    rl = []</span><br><span class="line">    sl = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">        io.sendline(CTX[i].<span class="built_in">hex</span>().encode())</span><br><span class="line">        r = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        s = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        rl.append(r)</span><br><span class="line">        sl.append(s)</span><br><span class="line">    r1, r2 = rl</span><br><span class="line">    s1, s2 = sl</span><br><span class="line">    k1 = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r1)), p))</span><br><span class="line">    k2 = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r2)), p))</span><br><span class="line">    <span class="built_in">print</span>(k1, k2)</span><br><span class="line">    pri = (s1 * k1 - s2 * k2) * <span class="built_in">pow</span>(r1 - r2, -<span class="number">1</span>, n) % n</span><br><span class="line">    r, s = sign(pri, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag2&#x27;</span>.encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    io.sendline((<span class="built_in">str</span>(r) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(s)).encode())</span><br><span class="line">    recv = io.recvline().decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Traceback&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(recv)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">if</span> playonce() == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># flag&#123;good_job_k33p_g01n9_for_level_3__TMXMhh6T&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="èµ›åè®¨è®º">èµ›åè®¨è®º</h4>
<p>æ¯”èµ›ç»“æŸåå’Œ shin äº¤æµäº†ä¸€ä¸‹ï¼Œå‘ç°è¿™é‡Œ k å…¶å®æ˜¯å¯ä»¥checkçš„ï¼Œç›´æ¥æ¯”è¾ƒ
k å’Œ ctx çš„é«˜ä½å°±è¡Œã€‚</p>
<h3 id="sign-the-ca7s">sign the ca7s</h3>
<p><strong>é¢˜ç›®æè¿°</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sign the cats, so that you can cat the flag! ğŸ±</span><br></pre></td></tr></table></figure>
<p><strong>é¢˜ç›®é™„ä»¶</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.sage</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;**redacted**&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(GF(<span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span>), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).x()) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">pub, ctx, msg, sig</span>):</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r, s = sig</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n:</span><br><span class="line">        <span class="keyword">return</span> r == <span class="built_in">int</span>((<span class="built_in">pow</span>(s, -<span class="number">1</span>, n) * (z * G + r * pub)).x()) % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chall</span>(<span class="params">level, flag</span>):</span><br><span class="line">    priv = randint(<span class="number">1</span>, n - <span class="number">1</span>)</span><br><span class="line">    pub = priv * G</span><br><span class="line">    msg = os.urandom(<span class="number">64</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;=== level <span class="subst">&#123;level&#125;</span> ===&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(catalan_number(level)):</span><br><span class="line">        ctx = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&#x27;context: &#x27;</span>))</span><br><span class="line">        r, s = sign(priv, ctx, msg)</span><br><span class="line">        <span class="keyword">assert</span> verify(pub, ctx, msg, (r, s))</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">1</span>: <span class="built_in">print</span>(<span class="string">&#x27;message:&#x27;</span>, msg.<span class="built_in">hex</span>())</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">2</span>: <span class="built_in">print</span>(<span class="string">&#x27;sign:&#x27;</span>, r)</span><br><span class="line">        <span class="keyword">if</span> level &lt;= <span class="number">3</span>: <span class="built_in">print</span>(<span class="string">&#x27;ature:&#x27;</span>, s)</span><br><span class="line">    </span><br><span class="line">    r, s = <span class="built_in">map</span>(<span class="built_in">int</span>, <span class="built_in">input</span>(<span class="string">&#x27;signature: &#x27;</span>).split())</span><br><span class="line">    <span class="keyword">assert</span> verify(pub, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag<span class="subst">&#123;level&#125;</span>&#x27;</span>.encode(), (r, s))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;flag<span class="subst">&#123;level&#125;</span>:&#x27;</span>, flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    chall(<span class="number">1</span>, <span class="string">&quot;ğŸ’§&quot;</span>)</span><br><span class="line">    chall(<span class="number">2</span>, <span class="string">&quot;ğŸ±&quot;</span>)</span><br><span class="line">    chall(<span class="number">3</span>, FLAG)</span><br></pre></td></tr></table></figure>
<h4 id="è§£é¢˜æ€è·¯-1">è§£é¢˜æ€è·¯</h4>
<p>æ¯” <strong>sign in the ca7s</strong> å¤šäº†ä¸€ä¸ªlevel 3ï¼Œè¿™æ¬¡ r
ä¹Ÿæ²¡æœ‰äº†ï¼Œ åªæœ‰ä¸€ä¸ª sï¼Œä½†ç­¾åæ¬¡æ•°æœ‰5æ¬¡ã€‚</p>
<p>è¾“å…¥è¿˜æ˜¯æ‰¾ 5 ä¸ªæœ‰ç›¸åŒmd5çš„ ctxï¼Œè¿™æ ·
<code>z = bytes_to_long(md5(ctx + msg).digest())</code>
å°±æ˜¯ä¸€æ ·çš„ï¼Œå¯¹äºä¸åŒçš„<code>k = bytes_to_long(ctx + md5(str(priv).encode() + msg).digest())</code>ï¼Œä»–ä»¬åªå·®äº†ä¸€ä¸ªå¸¸æ•°ï¼Œæ‰€ä»¥
5 ä¸ªä¸åŒçš„ k å¯ä»¥ç”¨ä¸€ä¸ªå˜é‡è¡¨ç¤ºã€‚æœ€åæ˜¯ rï¼Œä»–æ˜¯ k * G
çš„æ¨ªåæ ‡ï¼Œè®¾æ¨ªåæ ‡æ˜¯ x0ï¼Œå¯¹åº”çš„çºµåæ ‡æ˜¯ y0ï¼Œç”±äºä¸åŒçš„ k
å°±å·®äº†ä¸€ä¸ªå¸¸æ•°ï¼Œæ‰€ä»¥ä¸åŒçš„ k * G
å°±å·®äº†ä¸€ä¸ªç‚¹ï¼Œç”¨ä¸Šç‚¹åŠ æ³•å…¬å¼ï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰çš„ r ç”¨ x0ï¼Œy0 è¡¨ç¤ºã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¸€å…±æœ‰ 5 ä¸ªæœªçŸ¥æ•°ï¼šk, x0, y0, z, privã€‚ è€Œæˆ‘ä»¬æœ‰ 5
ä¸ªç­¾åæ–¹ç¨‹å’Œ 1 ä¸ªæ›²çº¿æ–¹ç¨‹ï¼Œæ‰€ä»¥æ˜¯å¯è§£çš„ã€‚</p>
<p>æœ€åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•æ‰¾åˆ° 5 ä¸ªå…·æœ‰ç›¸åŒ md5 çš„ ctxã€‚å¯ä»¥åˆ©ç”¨ fastcoll
è¿™æ ·æ“ä½œï¼šé¦–å…ˆç”Ÿæˆä¸¤ä¸ªå…·æœ‰ç›¸åŒ md5 çš„æ¶ˆæ¯ï¼Œè®°ä½œ <span class="math inline">\((A_1ï¼ŒA_2)\)</span>ï¼Œç„¶åéšä¾¿é€‰ä¸€ä¸ªï¼Œæ¯”å¦‚ <span class="math inline">\(A_1\)</span>ï¼Œä»¥ä»–ä¸ºå‰ç¼€å†ç”Ÿæˆ 2 ä¸ªç›¸åŒ md5
çš„æ•°æ®ï¼Œè®°ä½œ <span class="math inline">\((A_1||B_1ï¼ŒA_1||B_2)\)</span>ï¼Œç„¶åå†éšæœºé€‰ä¸€ä¸ªï¼Œæ¯”å¦‚
<span class="math inline">\(A_1||B_1\)</span>ï¼Œä»¥ä»–ä¸ºå‰ç¼€å†ç”Ÿæˆ 2 ä¸ªç›¸åŒ
md5 çš„æ•°æ®ï¼Œè®°ä½œ <span class="math inline">\((A_1||B_1||C_1ï¼ŒA_1||B_1||C_2)\)</span>ï¼Œè¿™æ ·
<span class="math inline">\(A_i||B_j||C_kï¼Œi,j,k \in \{1, 2\}\)</span>
çš„md5å°±éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<h4 id="exp-1">Exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.sage</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote, context</span><br><span class="line"><span class="keyword">from</span> ctf_tools.crypto.ECC.SmartAttack <span class="keyword">import</span> SmartAttack</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">0x1337_ca7_eae368ff5d702e6067aaaa77ca_ca7_1337</span></span><br><span class="line">E = EllipticCurve(GF(p), [<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">G, n = E(<span class="number">1</span>, <span class="number">2</span>), E.order()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">priv, ctx, msg</span>):</span><br><span class="line">    k = bytes_to_long(ctx + md5(<span class="built_in">str</span>(priv).encode() + msg).digest())</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r = <span class="built_in">int</span>((k * G).x()) % n</span><br><span class="line">    s = (<span class="built_in">pow</span>(k, -<span class="number">1</span>, n) * (z + r * priv)) % n</span><br><span class="line">    <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">pub, ctx, msg, sig</span>):</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    r, s = sig</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt; r &lt; n <span class="keyword">and</span> <span class="number">0</span> &lt; s &lt; n:</span><br><span class="line">        <span class="keyword">return</span> r == <span class="built_in">int</span>((<span class="built_in">pow</span>(s, -<span class="number">1</span>, n) * (z * G + r * pub)).x()) % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level1</span>(<span class="params">io</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">    ctx = <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">    io.sendline(ctx.<span class="built_in">hex</span>().encode())</span><br><span class="line">    msg = <span class="built_in">bytes</span>.fromhex(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    r = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    s = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    k = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r)), p))</span><br><span class="line">    z = bytes_to_long(md5(ctx + msg).digest())</span><br><span class="line">    pri = (s * k - z) * <span class="built_in">pow</span>(r, -<span class="number">1</span>, n) % n</span><br><span class="line">    r, s = sign(pri, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag1&#x27;</span>.encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    io.sendline((<span class="built_in">str</span>(r) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(s)).encode())</span><br><span class="line">    recv = io.recvline().decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Traceback&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level2</span>(<span class="params">io</span>):</span><br><span class="line">    ctx1 = <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07&#x27;</span></span><br><span class="line">    ctx2 = <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7~&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5\xc1\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1a\xeeZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x0bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbb\xe3\x01\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa,\x93\xb0\x9d\x07&#x27;</span></span><br><span class="line">    CTX = [ctx1, ctx2]</span><br><span class="line">    rl = []</span><br><span class="line">    sl = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">        io.sendline(CTX[i].<span class="built_in">hex</span>().encode())</span><br><span class="line">        r = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        s = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        rl.append(r)</span><br><span class="line">        sl.append(s)</span><br><span class="line">    r1, r2 = rl</span><br><span class="line">    s1, s2 = sl</span><br><span class="line">    k1 = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r1)), p))</span><br><span class="line">    k2 = <span class="built_in">int</span>(SmartAttack(G, E.lift_x(GF(p)(r2)), p))</span><br><span class="line">    <span class="comment"># print(k1, k2)</span></span><br><span class="line">    pri = (s1 * k1 - s2 * k2) * <span class="built_in">pow</span>(r1 - r2, -<span class="number">1</span>, n) % n</span><br><span class="line">    r, s = sign(pri, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag2&#x27;</span>.encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    io.sendline((<span class="built_in">str</span>(r) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(s)).encode())</span><br><span class="line">    recv = io.recvline().decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Traceback&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_equtions</span>(<span class="params">sl, CTX</span>):</span><br><span class="line">    CTX_num = [bytes_to_long(i) <span class="keyword">for</span> i <span class="keyword">in</span> CTX]</span><br><span class="line">    PR.&lt;k0, z, x0, y0, d&gt; = PolynomialRing(GF(p))</span><br><span class="line">    <span class="comment"># k0, z, x0, y0, d = var(&quot;k0, z, x0, y0, d&quot;)</span></span><br><span class="line">    eqs = [</span><br><span class="line">            y0**<span class="number">2</span> - (x0**<span class="number">3</span> + <span class="number">3</span>),</span><br><span class="line">            sl[<span class="number">0</span>] * k0 - (z + x0 * d)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        ki = k0 + (CTX_num[i] - CTX_num[<span class="number">0</span>]) * <span class="number">256</span> ** <span class="number">16</span></span><br><span class="line">        delta = (CTX_num[i] - CTX_num[<span class="number">0</span>]) * <span class="number">256</span> ** <span class="number">16</span> * G</span><br><span class="line">        delta_x, delta_y = delta.xy()</span><br><span class="line">        slope = (<span class="built_in">int</span>(delta_y) - y0) / (<span class="built_in">int</span>(delta_x) - x0)</span><br><span class="line">        xi = slope**<span class="number">2</span> - x0 - <span class="built_in">int</span>(delta_x)</span><br><span class="line">        eqs.append((sl[i] * ki - (z + xi * d)).numerator())</span><br><span class="line">    I = PR.ideal(eqs)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(I.groebner_basis()[-<span class="number">1</span>].univariate_polynomial().roots()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level3</span>(<span class="params">io</span>):</span><br><span class="line">    CTX = [<span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07\xc6\xbf\xe8\xd8\xce\xcf@j\xbb\xf8\x06\x1c^\x0e\x18\xf1\x9c\xdf?1]\xc7R\xfdH\xea:\xfej\x14&quot;\x0e\xa1\xbb\xad\xcc\xea\xc1\xec_g*\xd6\x9a\xae5\x14\x1b\xc0\xad\xf3h\x8e\x00M\x90#b\x81\xd5x&lt;,e\xae,\xc9\xb5\xdcX\x8e_\xaf\x0e$\xe1;\xcc\xd7\x1bR\x86\x9d\x13\x0e\xfb\xe0\x1c\xcd\xd7\x14\xc1\xd9ay.M1\x96\xbae\xf9\x8eSw\x91\xc1\xaf\x8d\xd6L\x86\x84Q\x03.\xdb5\xa1\xe5G\xde6\x8c\xec\xd4\x8c\x85\xf2\xd6Ec\xcc\xf9\xee\xef\xeb6\xf5U^+\x93\xc3P\x8a&#125;\xf4\xd2&#123;\xe2@5\xb2:&gt;C\xb8\t\r\xf2\xc9\xca\xe2L\xaf+=\x87H\xf8\xe4\r0\xd6Q\x07\x91\xd3\x8b5\xda\x9c]\x131l&#123;\x9a\x16\xceC\x0bz&gt;\xdd\x84\x0c\x83\xa8S\xb2\x8e9\x99\x19K\xdc\xb0\r\x002\xf9\x05&amp;m\xd1Z\xfe\xc6\xec\x06\xe2\xebx\x8e&amp;X\xf6I\xe8\xbexHDO\xa1\x84\xd1*S\xde\xbb\r\xb4&lt;_&#123;2\xdf\x83M\x8a\xb9\x12e&#x27;</span>, <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07\xc6\xbf\xe8\xd8\xce\xcf@j\xbb\xf8\x06\x1c^\x0e\x18\xf1\x9c\xdf?1]\xc7R\xfdH\xea:\xfej\x14&quot;\x0e\xa1\xbb\xad\xcc\xea\xc1\xec_g*\xd6\x9a\xae5\x14\x1b\xc0\xad\xf3h\x8e\x00M\x90#b\x81\xd5x&lt;,e\xae,\xc9\xb5\xdcX\x8e_\xaf\x0e$\xe1;\xcc\xd7\x1bR\x86\x9d\x13\x0e\xfb\xe0\x1c\xcd\xd7\x14\xc1\xd9ay.M1\x96\xbae\xf9\x8eSw\x91\xc1\xaf\x8d\xd6L\x86\x84Q\x03.\xdb5\xa1\xe5G\xde6\x8c\xec\xd4\x8c\x85\xf2\xd6Ec\xcc\xf9\xee\xef\xeb6\xf5U^+\x93\xc3P\x8a&#125;t\xd2&#123;\xe2@5\xb2:&gt;C\xb8\t\r\xf2\xc9\xca\xe2L\xaf+=\x87H\xf8\xe4\r\xb0\xd6Q\x07\x91\xd3\x8b5\xda\x9c]\x131l\xfb\x9a\x16\xceC\x0bz&gt;\xdd\x84\x0c\x83\xa8S\xb2\x8e9\x99\x19K\xdc\xb0\r\x00\xb2\xf9\x05&amp;m\xd1Z\xfe\xc6\xec\x06\xe2\xebx\x8e&amp;X\xf6I\xe8\xbexHDO\xa1\x04\xd1*S\xde\xbb\r\xb4&lt;_&#123;2\xdf\x83\xcd\x8a\xb9\x12e&#x27;</span>, <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07\xc6\xbf\xe8\xd8\xce\xcf@j\xbb\xf8\x06\x1c^\x0e\x18\xf1\x9c\xdf?\xb1]\xc7R\xfdH\xea:\xfej\x14&quot;\x0e\xa1\xbb\xad\xcc\xea\xc1\xec_g*\xd6\x9a\xae\xb5\x14\x1b\xc0\xad\xf3h\x8e\x00M\x90#b\x81Ux&lt;,e\xae,\xc9\xb5\xdcX\x8e_\xaf\x0e$\xe1;\xcc\xd7\x1bR\x86\x9d\x93\x0e\xfb\xe0\x1c\xcd\xd7\x14\xc1\xd9ay.M1\x96\xbae\xf9\x8eSw\x91\xc1\xaf\x8dVL\x86\x84Q\x03.\xdb5\xa1\xe5G\xde6\x0c\xec\xd4\x8c\x85\xf2\xd6Ec\xcc\xf9\xee\xef\xeb6\xf5U^+\x93\xc3P\x8a&#125;\xf4\xd2&#123;\xe2@5\xb2:&gt;C\xb8\t\r\xf2\xc9\xca\xe2L\xaf+=\x87H\xf8\xe4\r0\xd6Q\x07\x91\xd3\x8b5\xda\x9c]\x131l&#123;\x9a\x16\xceC\x0bz&gt;\xdd\x84\x0c\x83\xa8S\xb2\x8e9\x99\x19K\xdc\xb0\r\x002\xf9\x05&amp;m\xd1Z\xfe\xc6\xec\x06\xe2\xebx\x8e&amp;X\xf6I\xe8\xbexHDO\xa1\x84\xd1*S\xde\xbb\r\xb4&lt;_&#123;2\xdf\x83M\x8a\xb9\x12e&#x27;</span>, <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7\xfe&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5A\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1anZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x8bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbbc\x02\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa\xac\x93\xb0\x9d\x07\xc6\xbf\xe8\xd8\xce\xcf@j\xbb\xf8\x06\x1c^\x0e\x18\xf1\x9c\xdf?\xb1]\xc7R\xfdH\xea:\xfej\x14&quot;\x0e\xa1\xbb\xad\xcc\xea\xc1\xec_g*\xd6\x9a\xae\xb5\x14\x1b\xc0\xad\xf3h\x8e\x00M\x90#b\x81Ux&lt;,e\xae,\xc9\xb5\xdcX\x8e_\xaf\x0e$\xe1;\xcc\xd7\x1bR\x86\x9d\x93\x0e\xfb\xe0\x1c\xcd\xd7\x14\xc1\xd9ay.M1\x96\xbae\xf9\x8eSw\x91\xc1\xaf\x8dVL\x86\x84Q\x03.\xdb5\xa1\xe5G\xde6\x0c\xec\xd4\x8c\x85\xf2\xd6Ec\xcc\xf9\xee\xef\xeb6\xf5U^+\x93\xc3P\x8a&#125;t\xd2&#123;\xe2@5\xb2:&gt;C\xb8\t\r\xf2\xc9\xca\xe2L\xaf+=\x87H\xf8\xe4\r\xb0\xd6Q\x07\x91\xd3\x8b5\xda\x9c]\x131l\xfb\x9a\x16\xceC\x0bz&gt;\xdd\x84\x0c\x83\xa8S\xb2\x8e9\x99\x19K\xdc\xb0\r\x00\xb2\xf9\x05&amp;m\xd1Z\xfe\xc6\xec\x06\xe2\xebx\x8e&amp;X\xf6I\xe8\xbexHDO\xa1\x04\xd1*S\xde\xbb\r\xb4&lt;_&#123;2\xdf\x83\xcd\x8a\xb9\x12e&#x27;</span>, <span class="string">b&#x27;J\xc6 \x14\xe9a\xd6)&quot;\xeb\xc7\t%\xae\x95\xf3\xa3\xee\xc7~&amp;\xce\xd4\xae#\x02\x81&#125;\xc5\x1f\x9a\xc8\xa0\x05\xf2\xe2\xba\x0b\xc4,\xe7#q&lt;\xc5\xc1\xbe\x86\x85pv\x88\xe1/H\xdb_\x9a\x1a\xeeZ\x02\xdd\xcf_\xbbXz\xc56\x1c\xd2\xe9\x82R\xb7\xa6\xfe\x07a\xcbu\xd8\x0bX\x19\xf3\xd0\xc9\xc5\xf0\xce\xb6_H\xc7\xd3s\xca\xf7\xaf\x86r\x1e\xfbD\x8a;\xbb\xe3\x01\x10\xabg\xdc|\xe0|\xe6o6\xe9\xfa,\x93\xb0\x9d\x07\xc6\xbf\xe8\xd8\xce\xcf@j\xbb\xf8\x06\x1c^\x0e\x18\xf1\x9c\xdf?1]\xc7R\xfdH\xea:\xfej\x14&quot;\x0e\xa1\xbb\xad\xcc\xea\xc1\xec_g*\xd6\x9a\xae5\x14\x1b\xc0\xad\xf3h\x8e\x00M\x90#b\x81\xd5x&lt;,e\xae,\xc9\xb5\xdcX\x8e_\xaf\x0e$\xe1;\xcc\xd7\x1bR\x86\x9d\x13\x0e\xfb\xe0\x1c\xcd\xd7\x14\xc1\xd9ay.M1\x96\xbae\xf9\x8eSw\x91\xc1\xaf\x8d\xd6L\x86\x84Q\x03.\xdb5\xa1\xe5G\xde6\x8c\xec\xd4\x8c\x85\xf2\xd6Ec\xcc\xf9\xee\xef\xeb6\xf5U^+\x93\xc3P\x8a&#125;\xf4\xd2&#123;\xe2@5\xb2:&gt;C\xb8\t\r\xf2\xc9\xca\xe2L\xaf+=\x87H\xf8\xe4\r0\xd6Q\x07\x91\xd3\x8b5\xda\x9c]\x131l&#123;\x9a\x16\xceC\x0bz&gt;\xdd\x84\x0c\x83\xa8S\xb2\x8e9\x99\x19K\xdc\xb0\r\x002\xf9\x05&amp;m\xd1Z\xfe\xc6\xec\x06\xe2\xebx\x8e&amp;X\xf6I\xe8\xbexHDO\xa1\x84\xd1*S\xde\xbb\r\xb4&lt;_&#123;2\xdf\x83M\x8a\xb9\x12e&#x27;</span>]</span><br><span class="line">    sl = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;context: &quot;</span>)</span><br><span class="line">        io.sendline(CTX[i].<span class="built_in">hex</span>().encode())</span><br><span class="line">        s = <span class="built_in">int</span>(io.recvline().decode().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        sl.append(s)</span><br><span class="line">    priv = solve_equtions(sl, CTX)</span><br><span class="line">    r, s= sign(priv, <span class="string">b&#x27;n1junior_2025&#x27;</span>, <span class="string">f&#x27;cat /flag3&#x27;</span>.encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;signature: &quot;</span>)</span><br><span class="line">    io.sendline((<span class="built_in">str</span>(r) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(s)).encode())</span><br><span class="line">    recv = io.recvline().decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Traceback&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(recv)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">100</span>):</span><br><span class="line">    io = remote(<span class="string">&quot;60.205.163.215&quot;</span>, <span class="number">38176</span>)</span><br><span class="line">    <span class="keyword">if</span> level1(io) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> level2(io) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> level3(io) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Successfully&quot;</span>)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">io.close()</span><br><span class="line"><span class="comment"># flag&#123;wow_such_smart_very_MD5_much_r3la7ed_n0nc3s_kn9xyf8b&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="sign-one-m0re">sign one m0re</h3>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Can you break the one-more unforgeability of this signature scheme? ğŸ–Š</span><br><span class="line"></span><br><span class="line">hint</span><br><span class="line">1. Can you break the one-more **unforgeability** of this **provably secure partially blind signature** scheme?</span><br><span class="line">hint</span><br><span class="line">2. eROSion</span><br></pre></td></tr></table></figure>
<p><strong>é¢˜ç›®é™„ä»¶</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="keyword">from</span> fastecdsa.curve <span class="keyword">import</span> secp256k1</span><br><span class="line"><span class="keyword">from</span> fastecdsa.point <span class="keyword">import</span> Point</span><br><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> randbelow</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha512</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;**redacted**&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">MAX_SESSIONS = <span class="number">192</span></span><br><span class="line"></span><br><span class="line">p, q, G = secp256k1.p, secp256k1.q, secp256k1.G</span><br><span class="line">info = <span class="built_in">int</span>.from_bytes(<span class="string">b&quot;[N1CTF Junior 2025]&quot;</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">z = Point(info, <span class="built_in">pow</span>(info ** <span class="number">3</span> + <span class="number">7</span>, (p + <span class="number">1</span>) // <span class="number">4</span>, p), secp256k1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Signer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = randbelow(q)</span><br><span class="line">        <span class="variable language_">self</span>.y = <span class="variable language_">self</span>.x * G</span><br><span class="line">        <span class="variable language_">self</span>.sessions = &#123;sid: (<span class="number">0</span>, ) <span class="keyword">for</span> sid <span class="keyword">in</span> <span class="built_in">range</span>(MAX_SESSIONS)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_public_key</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">commit</span>(<span class="params">self, sid</span>):</span><br><span class="line">        <span class="keyword">assert</span> sid <span class="keyword">in</span> <span class="built_in">range</span>(MAX_SESSIONS), <span class="string">&quot;Invalid session&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="variable language_">self</span>.sessions[sid][<span class="number">0</span>] == <span class="number">0</span>, <span class="string">&quot;Invalid state&quot;</span></span><br><span class="line">        u, s, d = [randbelow(q) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">        a, b = u * G, s * G + d * z</span><br><span class="line">        <span class="variable language_">self</span>.sessions[sid] = (<span class="number">1</span>, u, s, d)</span><br><span class="line">        <span class="keyword">return</span> a, b</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self, sid, e</span>):</span><br><span class="line">        <span class="keyword">assert</span> sid <span class="keyword">in</span> <span class="built_in">range</span>(MAX_SESSIONS), <span class="string">&quot;Invalid session&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="variable language_">self</span>.sessions[sid][<span class="number">0</span>] == <span class="number">1</span>, <span class="string">&quot;Invalid state&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="number">1</span> &lt; e &lt; q, <span class="string">&quot;Invalid query&quot;</span></span><br><span class="line">        _, u, s, d = <span class="variable language_">self</span>.sessions[sid]</span><br><span class="line">        c = (e - d) % q</span><br><span class="line">        r = (u - c * <span class="variable language_">self</span>.x) % q</span><br><span class="line">        <span class="variable language_">self</span>.sessions[sid] = (<span class="number">2</span>, )</span><br><span class="line">        <span class="keyword">return</span> r, c, s, d</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Verifier</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.messages = <span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">oracle</span>(<span class="params">self, Î±, Î², z, msg</span>):</span><br><span class="line">        to_hash = <span class="string">&quot;||&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, [Î±.x, Î±.y, Î².x, Î².y, z.x, z.y, msg]))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(sha512(to_hash.encode()).digest(), <span class="string">&quot;big&quot;</span>) % q</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self, pub, sig, msg</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">all</span>(<span class="number">1</span> &lt; x &lt; q <span class="keyword">for</span> x <span class="keyword">in</span> sig), <span class="string">&quot;Invalid signature&quot;</span></span><br><span class="line">        Ï, Ï‰, Ïƒ, Î´ = sig</span><br><span class="line">        <span class="keyword">if</span> (Ï‰ + Î´) % q == <span class="variable language_">self</span>.oracle(Ï * G + Ï‰ * pub, Ïƒ * G + Î´ * z, z, msg):</span><br><span class="line">            <span class="variable language_">self</span>.messages.add(msg)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.messages) == MAX_SESSIONS + <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> FLAG</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Good signature&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Bad signature&quot;</span></span><br><span class="line"></span><br><span class="line">signal.alarm(<span class="number">300</span>)</span><br><span class="line">signer = Signer()</span><br><span class="line">verifier = Verifier()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd, *args = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>).split()</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">&quot;get_key&quot;</span>:</span><br><span class="line">        y = signer.get_public_key()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;y = (<span class="subst">&#123;y.x&#125;</span>, <span class="subst">&#123;y.y&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&quot;commit&quot;</span>:</span><br><span class="line">        sid = <span class="built_in">int</span>(args[<span class="number">0</span>])</span><br><span class="line">        a, b = signer.commit(sid)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;a = (<span class="subst">&#123;a.x&#125;</span>, <span class="subst">&#123;a.y&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;b = (<span class="subst">&#123;b.x&#125;</span>, <span class="subst">&#123;b.y&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&quot;sign&quot;</span>:</span><br><span class="line">        sid, e = <span class="built_in">int</span>(args[<span class="number">0</span>]), <span class="built_in">int</span>(args[<span class="number">1</span>])</span><br><span class="line">        r, c, s, d = signer.sign(sid, e)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;r = &#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;c = &#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;s = &#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;d = &#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> cmd == <span class="string">&quot;verify&quot;</span>:</span><br><span class="line">        sig, msg = <span class="built_in">tuple</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, args[:<span class="number">4</span>])), args[<span class="number">4</span>]</span><br><span class="line">        <span class="built_in">print</span>(verifier.verify(signer.get_public_key(), sig, msg))</span><br></pre></td></tr></table></figure>
<h4 id="è§£é¢˜æ€è·¯-2">è§£é¢˜æ€è·¯</h4>
<p>æ ¹æ®é¢˜ç›®ç»™çš„hintï¼Œæ‰¾åˆ°è¿™ç¯‡æ–‡ç« <a id="cite-1a" href="#ref-1" class="cite" role="doc-biblioref">[1]</a>ã€‚å‘ç°è®ºæ–‡çš„å‚æ•°å’Œé¢˜ç›®çš„å‚æ•°ååˆ†å»åˆã€‚ä¹‹å<a target="_blank" rel="noopener" href="https://lov2.netlify.app/"><span class="citation" data-cites="LOV3">@LOV3</span></a>æŠŠè¿™ç¯‡è®ºæ–‡äº¤ç»™AIåæˆåŠŸå¤ç°äº†å‡ºæ¥ï¼Œè€Œä¸”ä¸‹é¢çš„Expä¹Ÿæ˜¯AIå†™çš„ã€‚ç­‰æœ‰ç©ºäº†å†æ¥è®°å½•ä¸‹åŸç†å§ï¼ˆé€ƒ</p>
<h4 id="exp-2">Exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">One-shot ROS attack for &#x27;sign one m0re&#x27; challenge</span></span><br><span class="line"><span class="string">- Collect 192 commits (a_i, b_i)</span></span><br><span class="line"><span class="string">- For each i, precompute multiple candidate e_&#123;i,j&#125; = H(a_i, b_i, z, m_&#123;i,j&#125;) by varying messages</span></span><br><span class="line"><span class="string">- Build per-dimension lattices and solve via Babai to get mu_i</span></span><br><span class="line"><span class="string">- Decompose target to choose j_i per dimension so that sum K_i * e_&#123;i,j_i&#125; == e_forge</span></span><br><span class="line"><span class="string">- Query sign once per session with e_&#123;i,j_i&#125;, collect (r_i, c_i, s_i, d_i)</span></span><br><span class="line"><span class="string">- Forge (rho, omega, sigma, delta) = sum K_i * (r_i, c_i, s_i, d_i)</span></span><br><span class="line"><span class="string">- Verify forged signature on forged message to get flag</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">Notes:</span></span><br><span class="line"><span class="string">- All modular arithmetic is done mod n (curve order)</span></span><br><span class="line"><span class="string">- EC point ops use Sage on secp256k1 over GF(p)</span></span><br><span class="line"><span class="string">- Requires running with `sage -python one_shot_ros.py`</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"> </span><br><span class="line"><span class="comment"># secp256k1 params</span></span><br><span class="line">FIELD_P = Integer(<span class="number">0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f</span>)  <span class="comment"># field prime</span></span><br><span class="line">ORDER_N = Integer(<span class="number">0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141</span>)  <span class="comment"># group order</span></span><br><span class="line">Fp = GF(FIELD_P)</span><br><span class="line">Zn = GF(ORDER_N)</span><br><span class="line">E = EllipticCurve(Fp, [<span class="number">0</span>, <span class="number">7</span>])</span><br><span class="line">G = E(Integer(<span class="number">0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798</span>),</span><br><span class="line">      Integer(<span class="number">0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8</span>))</span><br><span class="line"> </span><br><span class="line">MAX_SESSIONS = <span class="number">192</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Fixed z from challenge</span></span><br><span class="line">INFO = <span class="built_in">int</span>.from_bytes(<span class="string">b&quot;[N1CTF Junior 2025]&quot;</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">z_point = E(Integer(INFO), Integer(<span class="built_in">pow</span>(INFO ** <span class="number">3</span> + <span class="number">7</span>, (FIELD_P + <span class="number">1</span>) // <span class="number">4</span>, FIELD_P)))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Oracle identical to challenge (mod n)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oracle</span>(<span class="params">alpha_pt, beta_pt, z_pt, msg_str</span>):</span><br><span class="line">    to_hash = <span class="string">&quot;||&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, [<span class="built_in">int</span>(alpha_pt[<span class="number">0</span>]), <span class="built_in">int</span>(alpha_pt[<span class="number">1</span>]), <span class="built_in">int</span>(beta_pt[<span class="number">0</span>]), <span class="built_in">int</span>(beta_pt[<span class="number">1</span>]), <span class="built_in">int</span>(z_pt[<span class="number">0</span>]), <span class="built_in">int</span>(z_pt[<span class="number">1</span>]), msg_str]))</span><br><span class="line">    <span class="keyword">return</span> Integer(<span class="built_in">int</span>.from_bytes(hashlib.sha512(to_hash.encode()).digest(), <span class="string">&quot;big&quot;</span>)) % ORDER_N</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Utilities</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inner_product</span>(<span class="params">coeffs, vals</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(c * v <span class="keyword">for</span> c, v <span class="keyword">in</span> <span class="built_in">zip</span>(coeffs, vals))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scale_to_Zn</span>(<span class="params">vec</span>):</span><br><span class="line">    <span class="comment"># Convert a vector of rationals in Zn to a single Zn element (first entry) after solving</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">all</span>(gcd(ORDER_N, el.denominator()) == <span class="number">1</span> <span class="keyword">for</span> el <span class="keyword">in</span> vec)</span><br><span class="line">    <span class="keyword">return</span> vector(Zn, [Zn(el.numerator()) / Zn(el.denominator()) <span class="keyword">for</span> el <span class="keyword">in</span> vec])</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pows_gen</span>(<span class="params">n=<span class="number">7</span>, group_bit_len=<span class="number">256</span>, extra_digits=<span class="number">0</span></span>):</span><br><span class="line">    <span class="comment"># Same as provided Sage, but using ORDER_N</span></span><br><span class="line">    max_number = Integer(<span class="number">2</span>) ** group_bit_len</span><br><span class="line">    <span class="keyword">assert</span> n &gt;= <span class="number">2</span></span><br><span class="line">    factored = []</span><br><span class="line">    k = n - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> k &gt;= <span class="number">1</span>:</span><br><span class="line">        B = QQ(<span class="number">1</span>) / QQ(<span class="number">500</span>)  <span class="comment"># practical tweak</span></span><br><span class="line">        max_k = ceil(log(max_number, k + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> k == <span class="number">1</span>:</span><br><span class="line">            e_k = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            e_k = ceil(log(B * log(ORDER_N, k + <span class="number">1</span>) * ORDER_N ** ((k - <span class="number">1</span>) / k), k + <span class="number">1</span>)) + extra_digits</span><br><span class="line">        factored = [(k + <span class="number">1</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(e_k, max_k)] + factored</span><br><span class="line">        max_number = (k + <span class="number">1</span>) ** e_k</span><br><span class="line">        k -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> factored  <span class="comment"># list of (base, exponent)</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multibase</span>(<span class="params">num_int, pows</span>):</span><br><span class="line">    <span class="comment"># pows is list of integers (bases already exponentiated)</span></span><br><span class="line">    temp = Integer(num_int)</span><br><span class="line">    digits = []</span><br><span class="line">    <span class="keyword">for</span> base <span class="keyword">in</span> pows[::-<span class="number">1</span>]:</span><br><span class="line">        digits = [temp // base] + digits</span><br><span class="line">        temp = temp % base</span><br><span class="line">    <span class="keyword">assert</span> inner_product(digits, pows) == num_int</span><br><span class="line">    <span class="keyword">return</span> digits</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose_pows_up_to</span>(<span class="params">max_sessions=<span class="number">192</span>, start_basis=<span class="number">7</span>, max_basis_cap=<span class="number">12</span></span>):</span><br><span class="line">    <span class="comment"># Try to get len(pows) as close to max_sessions without exceeding</span></span><br><span class="line">    best = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> mb <span class="keyword">in</span> <span class="built_in">range</span>(start_basis, max_basis_cap + <span class="number">1</span>):</span><br><span class="line">        factored = pows_gen(n=mb + <span class="number">1</span>, group_bit_len=ceil(log(ORDER_N, <span class="number">2</span>)), extra_digits=<span class="number">0</span>)</span><br><span class="line">        pows = [Integer(b) ** Integer(e) <span class="keyword">for</span> (b, e) <span class="keyword">in</span> factored]</span><br><span class="line">        <span class="keyword">if</span> best <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> (<span class="built_in">len</span>(pows) &lt;= max_sessions <span class="keyword">and</span> <span class="built_in">len</span>(pows) &gt; <span class="built_in">len</span>(best[<span class="number">0</span>])):</span><br><span class="line">            best = (pows, [b <span class="keyword">for</span> (b, e) <span class="keyword">in</span> factored])</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pows) == max_sessions:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># If still shorter, pad with base=2 powers of 1 to reach max_sessions (benign extra dims)</span></span><br><span class="line">    pows, bases = best</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pows) &lt; max_sessions:</span><br><span class="line">        pad = [Integer(<span class="number">2</span>)] * (max_sessions - <span class="built_in">len</span>(pows))</span><br><span class="line">        pows = pows + pad</span><br><span class="line">        bases = bases + [<span class="number">2</span>] * <span class="built_in">len</span>(pad)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pows) &gt; max_sessions:</span><br><span class="line">        pows = pows[:max_sessions]</span><br><span class="line">        bases = bases[:max_sessions]</span><br><span class="line">    <span class="keyword">return</span> pows, bases</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    context = contextlib = <span class="literal">None</span>  <span class="comment"># avoid lint</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] One-shot ROS attack starting...&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Connect to challenge</span></span><br><span class="line">    io = process([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;/d/CTF/Chall/2025/N1junior_2/sign_one_m0re/attachment/server.py&#x27;</span>])</span><br><span class="line">    <span class="comment"># io = remote(&quot;60.205.163.215&quot;, 33073)</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Get public key</span></span><br><span class="line">    io.sendline(<span class="string">b&quot;get_key&quot;</span>)</span><br><span class="line">    line = io.recvline().decode().strip()</span><br><span class="line">    y_coords = line.split(<span class="string">&quot;y = (&quot;</span>)[<span class="number">1</span>].rstrip(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">    yx, yy = <span class="built_in">map</span>(<span class="built_in">int</span>, y_coords.split(<span class="string">&quot;, &quot;</span>))</span><br><span class="line">    Y = E(Integer(yx), Integer(yy))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Public key Y.x=<span class="subst">&#123;yx&#125;</span>&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Choose bases and pows</span></span><br><span class="line">    pows, pows_bases = choose_pows_up_to(MAX_SESSIONS, start_basis=<span class="number">7</span>, max_basis_cap=<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> powi <span class="keyword">in</span> pows:</span><br><span class="line">        <span class="built_in">print</span>(factor(powi))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pows_bases = &#125;</span>&quot;</span>)</span><br><span class="line">    ell = <span class="built_in">len</span>(pows)</span><br><span class="line">    <span class="keyword">assert</span> ell == MAX_SESSIONS, <span class="string">f&quot;ell=<span class="subst">&#123;ell&#125;</span> != <span class="subst">&#123;MAX_SESSIONS&#125;</span>, adjust choose_pows_up_to&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] ell = <span class="subst">&#123;ell&#125;</span> dimensions&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Collect commits (a_i, b_i)</span></span><br><span class="line">    A_pts = []</span><br><span class="line">    B_pts = []</span><br><span class="line">    a_coords_list = []</span><br><span class="line">    b_coords_list = []</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> sid <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        io.sendline(<span class="string">f&quot;commit <span class="subst">&#123;sid&#125;</span>&quot;</span>.encode())</span><br><span class="line">        la = io.recvline().decode().strip()</span><br><span class="line">        lb = io.recvline().decode().strip()</span><br><span class="line">        ax_s = la.split(<span class="string">&quot;a = (&quot;</span>)[<span class="number">1</span>].rstrip(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        bx_s = lb.split(<span class="string">&quot;b = (&quot;</span>)[<span class="number">1</span>].rstrip(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        ax, ay = <span class="built_in">map</span>(<span class="built_in">int</span>, ax_s.split(<span class="string">&quot;, &quot;</span>))</span><br><span class="line">        bx, by = <span class="built_in">map</span>(<span class="built_in">int</span>, bx_s.split(<span class="string">&quot;, &quot;</span>))</span><br><span class="line">        a_pt = E(Integer(ax), Integer(ay))</span><br><span class="line">        b_pt = E(Integer(bx), Integer(by))</span><br><span class="line">        A_pts.append(a_pt)</span><br><span class="line">        B_pts.append(b_pt)</span><br><span class="line">        a_coords_list.append((ax, ay))</span><br><span class="line">        b_coords_list.append((bx, by))</span><br><span class="line">        <span class="keyword">if</span> sid % <span class="number">32</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] commit <span class="subst">&#123;sid&#125;</span>/<span class="subst">&#123;ell&#125;</span>&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Generate candidate messages and e-values per dimension</span></span><br><span class="line">    <span class="comment"># For each i: generate pows_bases[i] candidates indexed 0..B_i-1</span></span><br><span class="line">    msgs = []</span><br><span class="line">    e_values = []  <span class="comment"># list of lists of integers mod n</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        Bi = <span class="built_in">int</span>(pows_bases[i])</span><br><span class="line">        mi_list = []</span><br><span class="line">        ei_list = []</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(Bi):</span><br><span class="line">            m = <span class="string">f&quot;m<span class="subst">&#123;i&#125;</span>_<span class="subst">&#123;b&#125;</span>_<span class="subst">&#123;os.urandom(<span class="number">8</span>).<span class="built_in">hex</span>()&#125;</span>&quot;</span></span><br><span class="line">            eib = oracle(A_pts[i], B_pts[i], z_point, m)</span><br><span class="line">            mi_list.append(m)</span><br><span class="line">            ei_list.append(<span class="built_in">int</span>(eib))</span><br><span class="line">        msgs.append(mi_list)</span><br><span class="line">        e_values.append(ei_list)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">32</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] candidates <span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;ell&#125;</span>&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Build qi and lattices M_i</span></span><br><span class="line">    qi = []  <span class="comment"># differences list for each i: [e_i_b - e_i_0] for b&gt;=1</span></span><br><span class="line">    M = []</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        base_e0 = Integer(e_values[i][<span class="number">0</span>])</span><br><span class="line">        diffs = [Integer((Integer(e_values[i][b]) - base_e0) % ORDER_N) <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">int</span>(pows_bases[i]))]</span><br><span class="line">        qi.append(diffs)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(diffs) &gt; <span class="number">0</span>:</span><br><span class="line">            top = Matrix(ZZ, [diffs])  <span class="comment"># 1 x (Bi-1)</span></span><br><span class="line">            bottom = ORDER_N * matrix.identity(ZZ, <span class="built_in">len</span>(diffs))  <span class="comment"># (Bi-1) x (Bi-1)</span></span><br><span class="line">            Mi = block_matrix([[top], [bottom]])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Mi = matrix(ZZ, [[<span class="built_in">int</span>(ORDER_N)]])</span><br><span class="line">        M.append(Mi)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Solve CVP with Babai per dimension to obtain mu_i in Zn</span></span><br><span class="line">    mu = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        Bi = <span class="built_in">int</span>(pows_bases[i])</span><br><span class="line">        <span class="keyword">if</span> Bi &gt; <span class="number">1</span>:</span><br><span class="line">            tgt = vector(ZZ, [<span class="built_in">int</span>(j * Integer(pows[i])) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, Bi)])</span><br><span class="line">            lattice = IntegerLattice(M[i])</span><br><span class="line">            closest = vector(ZZ, lattice.babai(tgt))</span><br><span class="line">            sol = M[i].solve_left(closest)  <span class="comment"># rational vector (length 1)</span></span><br><span class="line">            mu_i = (Zn(<span class="number">1</span>) / Zn(<span class="built_in">int</span>(pows[i]))) * scale_to_Zn(sol)[<span class="number">0</span>]</span><br><span class="line">            mu.append(mu_i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mu.append(Zn.random_element())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] mu computed&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Forge target alpha,beta points (base sums)</span></span><br><span class="line">    <span class="comment"># alpha_base = sum pows[i]*mu[i] * A_pts[i]</span></span><br><span class="line">    <span class="comment"># beta_base  = sum pows[i]*mu[i] * B_pts[i]</span></span><br><span class="line">    alpha_base = <span class="literal">None</span></span><br><span class="line">    beta_base = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        coeff = <span class="built_in">int</span>((Zn(<span class="built_in">int</span>(pows[i])) * mu[i]).lift())  <span class="comment"># 0..n-1</span></span><br><span class="line">        <span class="keyword">if</span> coeff % <span class="built_in">int</span>(ORDER_N) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        term_a = Integer(coeff) * A_pts[i]</span><br><span class="line">        term_b = Integer(coeff) * B_pts[i]</span><br><span class="line">        alpha_base = term_a <span class="keyword">if</span> alpha_base <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> alpha_base + term_a</span><br><span class="line">        beta_base = term_b <span class="keyword">if</span> beta_base <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> beta_base + term_b</span><br><span class="line">    <span class="keyword">if</span> alpha_base <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] alpha_base is None, abort&quot;</span>)</span><br><span class="line">        io.close(); <span class="keyword">return</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Try decomposition attempts</span></span><br><span class="line">    attempts = <span class="number">0</span></span><br><span class="line">    success = <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span> attempts &lt; <span class="number">80</span> <span class="keyword">and</span> <span class="keyword">not</span> success:</span><br><span class="line">        attempts += <span class="number">1</span></span><br><span class="line">        extra_alpha = Zn.random_element()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(extra_alpha) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        inv_extra = Zn(<span class="built_in">int</span>(<span class="built_in">pow</span>(<span class="built_in">int</span>(extra_alpha), -<span class="number">1</span>, <span class="built_in">int</span>(ORDER_N))))</span><br><span class="line"> </span><br><span class="line">        alpha_forge = <span class="built_in">int</span>(extra_alpha) * alpha_base</span><br><span class="line">        beta_forge = <span class="built_in">int</span>(extra_alpha) * beta_base</span><br><span class="line">        msg_forge = <span class="string">f&quot;forge_msg_<span class="subst">&#123;os.urandom(<span class="number">6</span>).<span class="built_in">hex</span>()&#125;</span>&quot;</span></span><br><span class="line">        c_forge = Integer(oracle(alpha_forge, beta_forge, z_point, msg_forge))  <span class="comment"># in [0,n)</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># NUM = extra_alpha^&#123;-1&#125; * c_forge + sum pows*mu*(-e_i0) mod n</span></span><br><span class="line">        NUM = (inv_extra * Zn(<span class="built_in">int</span>(c_forge)))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">            NUM += (Zn(<span class="number">0</span>) - (Zn(<span class="built_in">int</span>(pows[i])) * mu[i] * Zn(<span class="built_in">int</span>(e_values[i][<span class="number">0</span>]))))</span><br><span class="line">        NUM_int = Integer(<span class="built_in">int</span>(NUM.lift()))  <span class="comment"># 0..n-1</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># greedy digit by digit</span></span><br><span class="line">        digits = [<span class="number">0</span>] * ell</span><br><span class="line">        NUM_cur = NUM_int</span><br><span class="line">        ok = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cur_digits = multibase(NUM_cur, [Integer(x) <span class="keyword">for</span> x <span class="keyword">in</span> pows])</span><br><span class="line">            <span class="keyword">except</span> AssertionError:</span><br><span class="line">                ok = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            new_digit = <span class="built_in">int</span>(cur_digits[i])</span><br><span class="line">            digits[i] = new_digit</span><br><span class="line">            <span class="keyword">if</span> new_digit &gt;= <span class="built_in">int</span>(pows_bases[i]):</span><br><span class="line">                ok = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> new_digit != <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># NUM_cur -= pows[i] * mu[i] * qi[i][new_digit-1] (mod n) as integer representative</span></span><br><span class="line">                delta = (Zn(<span class="built_in">int</span>(pows[i])) * mu[i] * Zn(<span class="built_in">int</span>(qi[i][new_digit - <span class="number">1</span>])))</span><br><span class="line">                NUM_cur = Integer((NUM_cur - <span class="built_in">int</span>(delta.lift())) % <span class="built_in">int</span>(ORDER_N))</span><br><span class="line">            <span class="keyword">if</span> NUM_cur &lt; <span class="number">0</span>:</span><br><span class="line">                ok = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> NUM_cur == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># can break early only if remaining higher digits are 0</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> ok <span class="keyword">and</span> NUM_cur == <span class="number">0</span>:</span><br><span class="line">            success = <span class="literal">True</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Decomposition success in <span class="subst">&#123;attempts&#125;</span> attempts&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> attempts % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] attempt <span class="subst">&#123;attempts&#125;</span> failed&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Decomposition failed. Consider rerunning.&quot;</span>)</span><br><span class="line">        io.close(); <span class="keyword">return</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># With digits selected, we now sign once per session using e_i = e_values[i][digits[i]]</span></span><br><span class="line">    <span class="comment"># and immediately verify to accumulate 192 messages in the verifier</span></span><br><span class="line">    signed = []  <span class="comment"># tuples (r,c,s,d,msg)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        e_sel = <span class="built_in">int</span>(e_values[i][digits[i]])</span><br><span class="line">        msg_i = msgs[i][digits[i]]</span><br><span class="line">        io.sendline(<span class="string">f&quot;sign <span class="subst">&#123;i&#125;</span> <span class="subst">&#123;e_sel&#125;</span>&quot;</span>.encode())</span><br><span class="line">        r_line = io.recvline().decode().strip(); r = <span class="built_in">int</span>(r_line.split(<span class="string">&quot;r = &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        c_line = io.recvline().decode().strip(); c = <span class="built_in">int</span>(c_line.split(<span class="string">&quot;c = &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        s_line = io.recvline().decode().strip(); s = <span class="built_in">int</span>(s_line.split(<span class="string">&quot;s = &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        d_line = io.recvline().decode().strip(); d = <span class="built_in">int</span>(d_line.split(<span class="string">&quot;d = &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">        signed.append((r, c, s, d, msg_i))</span><br><span class="line">        <span class="comment"># verify this legit signature to populate set</span></span><br><span class="line">        io.sendline(<span class="string">f&quot;verify <span class="subst">&#123;r&#125;</span> <span class="subst">&#123;c&#125;</span> <span class="subst">&#123;s&#125;</span> <span class="subst">&#123;d&#125;</span> <span class="subst">&#123;msg_i&#125;</span>&quot;</span>.encode())</span><br><span class="line">        vr = io.recvline().decode().strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Good signature&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> vr <span class="keyword">and</span> <span class="string">&quot;flag&#123;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> vr:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] Legit signature verify failed for session <span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;vr&#125;</span>&quot;</span>)</span><br><span class="line">            io.close(); <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">32</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] verified legit <span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;ell&#125;</span>&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Compute forged signature as linear combination with K_i = extra_alpha * pows[i] * mu[i]</span></span><br><span class="line">    rho_f = <span class="number">0</span>; omega_f = <span class="number">0</span>; sigma_f = <span class="number">0</span>; delta_f = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ell):</span><br><span class="line">        Ki = <span class="built_in">int</span>((extra_alpha * Zn(<span class="built_in">int</span>(pows[i])) * mu[i]).lift()) % <span class="built_in">int</span>(ORDER_N)</span><br><span class="line">        r, c, s, d, _ = signed[i]</span><br><span class="line">        rho_f = (rho_f + Ki * r) % <span class="built_in">int</span>(ORDER_N)</span><br><span class="line">        omega_f = (omega_f + Ki * c) % <span class="built_in">int</span>(ORDER_N)</span><br><span class="line">        sigma_f = (sigma_f + Ki * s) % <span class="built_in">int</span>(ORDER_N)</span><br><span class="line">        delta_f = (delta_f + Ki * d) % <span class="built_in">int</span>(ORDER_N)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Final verify forged signature to trigger the flag</span></span><br><span class="line">    io.sendline(<span class="string">f&quot;verify <span class="subst">&#123;rho_f&#125;</span> <span class="subst">&#123;omega_f&#125;</span> <span class="subst">&#123;sigma_f&#125;</span> <span class="subst">&#123;delta_f&#125;</span> <span class="subst">&#123;msg_forge&#125;</span>&quot;</span>.encode())</span><br><span class="line">    res = io.recvline().decode().strip()</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"> </span><br><span class="line">    io.close()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># flag&#123;ROS_attack__with_dimensional_eROSion_t9uKVDXg&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="sm1Â¼">SM1Â¼</h3>
<p><strong>é¢˜ç›®æè¿°</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SM4 is a secure block cipher. So is SM1Â¼. ğŸ”’</span><br></pre></td></tr></table></figure>
<p><strong>é¢˜ç›®é™„ä»¶</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FLAG = os.environ.get(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;flag&#123;**redacted**&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = (</span><br><span class="line">    <span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">    <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">    <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">    <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">    <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">    <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">    <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">    <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">    <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">    <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">    <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">FK = (</span><br><span class="line">    <span class="number">0xA3B1BAC6</span>, <span class="number">0x56AA3350</span>, <span class="number">0x677D9197</span>, <span class="number">0xB27022DC</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CK = (</span><br><span class="line">    <span class="number">0x00070E15</span>, <span class="number">0x1C232A31</span>, <span class="number">0x383F464D</span>, <span class="number">0x545B6269</span>,</span><br><span class="line">    <span class="number">0x70777E85</span>, <span class="number">0x8C939AA1</span>, <span class="number">0xA8AFB6BD</span>, <span class="number">0xC4CBD2D9</span>,</span><br><span class="line">    <span class="number">0xE0E7EEF5</span>, <span class="number">0xFC030A11</span>, <span class="number">0x181F262D</span>, <span class="number">0x343B4249</span>,</span><br><span class="line">    <span class="number">0x50575E65</span>, <span class="number">0x6C737A81</span>, <span class="number">0x888F969D</span>, <span class="number">0xA4ABB2B9</span>,</span><br><span class="line">    <span class="number">0xC0C7CED5</span>, <span class="number">0xDCE3EAF1</span>, <span class="number">0xF8FF060D</span>, <span class="number">0x141B2229</span>,</span><br><span class="line">    <span class="number">0x30373E45</span>, <span class="number">0x4C535A61</span>, <span class="number">0x686F767D</span>, <span class="number">0x848B9299</span>,</span><br><span class="line">    <span class="number">0xA0A7AEB5</span>, <span class="number">0xBCC3CAD1</span>, <span class="number">0xD8DFE6ED</span>, <span class="number">0xF4FB0209</span>,</span><br><span class="line">    <span class="number">0x10171E25</span>, <span class="number">0x2C333A41</span>, <span class="number">0x484F565D</span>, <span class="number">0x646B7279</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">l2b = <span class="keyword">lambda</span> x: x.to_bytes(<span class="number">4</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">b2l = <span class="keyword">lambda</span> x: <span class="built_in">int</span>.from_bytes(x, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">Ï„   = <span class="keyword">lambda</span> x: b2l(<span class="built_in">bytes</span>(S[y] <span class="keyword">for</span> y <span class="keyword">in</span> l2b(x)))</span><br><span class="line">rol = <span class="keyword">lambda</span> x, y: ((x &lt;&lt; y) | (x &gt;&gt; (<span class="number">32</span> - y))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">L   = <span class="keyword">lambda</span> x: x ^ rol(x, <span class="number">2</span>) ^ rol(x, <span class="number">10</span>) ^ rol(x, <span class="number">18</span>) ^ rol(x, <span class="number">24</span>)</span><br><span class="line">L_  = <span class="keyword">lambda</span> x: x ^ rol(x, <span class="number">13</span>) ^ rol(x, <span class="number">23</span>)</span><br><span class="line">T   = <span class="keyword">lambda</span> x: L(Ï„(x))</span><br><span class="line">T_  = <span class="keyword">lambda</span> x: L_(Ï„(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc_block</span>(<span class="params">key, block, nr=<span class="number">32</span></span>):</span><br><span class="line">    K = [b2l(key[i : i + <span class="number">4</span>]) ^ FK[i // <span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line">    X = [b2l(block[i : i + <span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nr):</span><br><span class="line">        K += [K[i] ^ T_(CK[i] ^ K[i + <span class="number">1</span>] ^ K[i + <span class="number">2</span>] ^ K[i + <span class="number">3</span>])]</span><br><span class="line">        X += [X[i] ^ T(X[i + <span class="number">1</span>] ^ X[i + <span class="number">2</span>] ^ X[i + <span class="number">3</span>] ^ K[i + <span class="number">4</span>])]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(l2b(X[nr + <span class="number">3</span> - i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc</span>(<span class="params">key, pt, nr=<span class="number">32</span></span>):</span><br><span class="line">    pt = pad(pt, <span class="number">16</span>)</span><br><span class="line">    ct = <span class="built_in">bytes</span>(<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(pt), <span class="number">16</span>):</span><br><span class="line">        ct += enc_block(key, strxor(pt[i : i + <span class="number">16</span>], ct[-<span class="number">16</span> : ]), nr)</span><br><span class="line">    <span class="keyword">return</span> ct[<span class="number">16</span> : ]</span><br><span class="line"></span><br><span class="line">key = os.urandom(<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(enc(key, FLAG.encode()).<span class="built_in">hex</span>())</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    pt = <span class="built_in">bytes</span>.fromhex(<span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(enc(key, pt, <span class="number">10</span>).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>
<h4 id="è§£é¢˜æ€è·¯-3">è§£é¢˜æ€è·¯</h4>
<p>æœåˆ°è¿™ç¯‡æ–‡ç« <a id="cite-2a" href="#ref-2" class="cite" role="doc-biblioref">[2]</a>ï¼Œä¾æ—§æ˜¯<a target="_blank" rel="noopener" href="https://lov2.netlify.app/"><span class="citation" data-cites="LOV3">@LOV3</span></a>æŠŠè¿™ç¯‡è®ºæ–‡äº¤ç»™AIï¼Œå†™äº†ä¸€ä»½Expï¼Œæˆ‘å°±æ”¹äº†ä¸€ä¸‹å¹¶è¡Œäº¤äº’ã€‚</p>
<h4 id="exp-3">Exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">æ¢å¤ 10 è½®æœ€åä¸€è½®å¯†é’¥ K13ï¼ˆoracle ç‰ˆï¼‰</span></span><br><span class="line"><span class="string">- ç›´æ¥å¯¹æ¥æœ¬ç›®å½•çš„ server.pyï¼ˆå›ºå®šå¯†é’¥ï¼Œ10è½®oracleï¼‰</span></span><br><span class="line"><span class="string">- ä½¿ç”¨è®ºæ–‡æ‰©å±•çš„ 2^16 ç»“æ„åŒ–ç§¯åˆ†ï¼š</span></span><br><span class="line"><span class="string">  S0 = (Î”(a), (C,C,C,Î´), (C,C,C,Î´), (C,C,C,Î´))ï¼Œa,Î´âˆˆ[0,255]</span></span><br><span class="line"><span class="string">  å…¶ä¸­ Î”(a) = L(0,0,0,a) âŠ• C1</span></span><br><span class="line"><span class="string">- è®¡ç®—ï¼š</span></span><br><span class="line"><span class="string">  t = L^&#123;-1&#125;( âŠ• C0 )</span></span><br><span class="line"><span class="string">  U = C3 âŠ• C2 âŠ• C1</span></span><br><span class="line"><span class="string">  å¯¹æ¯ä¸ªå­—èŠ‚ bï¼Œæ‰¾åˆ°æ‰€æœ‰ guess g æ»¡è¶³ âŠ• S[ U_b âŠ• g ] == t_b</span></span><br><span class="line"><span class="string">- å¤šåŸºåº•å¯è¿›ä¸€æ­¥äº¤å‰ç­›é€‰ï¼ˆè‹¥éœ€è¦ï¼‰ã€‚æœ¬è„šæœ¬å…ˆç”¨å•åŸºåº•éªŒè¯åœ¨å½“å‰å®ç°ä¸‹å¯å”¯ä¸€åŒ–ã€‚</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor</span><br><span class="line"><span class="keyword">import</span> sys, re, time</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- SMS4 primitives ---</span></span><br><span class="line">S = (</span><br><span class="line">    <span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">    <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">    <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">    <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">    <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">    <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">    <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">    <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">    <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">    <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">    <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">l2b = <span class="keyword">lambda</span> x: x.to_bytes(<span class="number">4</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">b2l = <span class="keyword">lambda</span> x: <span class="built_in">int</span>.from_bytes(x, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">rol = <span class="keyword">lambda</span> x, y: ((x &lt;&lt; y) | (x &gt;&gt; (<span class="number">32</span> - y))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">L   = <span class="keyword">lambda</span> x: x ^ rol(x, <span class="number">2</span>) ^ rol(x, <span class="number">10</span>) ^ rol(x, <span class="number">18</span>) ^ rol(x, <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L_inv</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    y = x</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        y = x ^ (rol(y,<span class="number">2</span>) ^ rol(y,<span class="number">10</span>) ^ rol(y,<span class="number">18</span>) ^ rol(y,<span class="number">24</span>))</span><br><span class="line">    <span class="keyword">return</span> y &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># byte-wise S-box on 32-bit</span></span><br><span class="line">Ï„ = <span class="keyword">lambda</span> x: b2l(<span class="built_in">bytes</span>(S[b] <span class="keyword">for</span> b <span class="keyword">in</span> l2b(x)))</span><br><span class="line">T = <span class="keyword">lambda</span> x: L(Ï„(x))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key schedule constants and transform</span></span><br><span class="line">FK = (<span class="number">0xA3B1BAC6</span>, <span class="number">0x56AA3350</span>, <span class="number">0x677D9197</span>, <span class="number">0xB27022DC</span>)</span><br><span class="line">CK = (</span><br><span class="line">    <span class="number">0x00070E15</span>, <span class="number">0x1C232A31</span>, <span class="number">0x383F464D</span>, <span class="number">0x545B6269</span>,</span><br><span class="line">    <span class="number">0x70777E85</span>, <span class="number">0x8C939AA1</span>, <span class="number">0xA8AFB6BD</span>, <span class="number">0xC4CBD2D9</span>,</span><br><span class="line">    <span class="number">0xE0E7EEF5</span>, <span class="number">0xFC030A11</span>, <span class="number">0x181F262D</span>, <span class="number">0x343B4249</span>,</span><br><span class="line">    <span class="number">0x50575E65</span>, <span class="number">0x6C737A81</span>, <span class="number">0x888F969D</span>, <span class="number">0xA4ABB2B9</span>,</span><br><span class="line">    <span class="number">0xC0C7CED5</span>, <span class="number">0xDCE3EAF1</span>, <span class="number">0xF8FF060D</span>, <span class="number">0x141B2229</span>,</span><br><span class="line">    <span class="number">0x30373E45</span>, <span class="number">0x4C535A61</span>, <span class="number">0x686F767D</span>, <span class="number">0x848B9299</span>,</span><br><span class="line">    <span class="number">0xA0A7AEB5</span>, <span class="number">0xBCC3CAD1</span>, <span class="number">0xD8DFE6ED</span>, <span class="number">0xF4FB0209</span>,</span><br><span class="line">    <span class="number">0x10171E25</span>, <span class="number">0x2C333A41</span>, <span class="number">0x484F565D</span>, <span class="number">0x646B7279</span>,</span><br><span class="line">)</span><br><span class="line">T_ = <span class="keyword">lambda</span> x: (x ^ rol(x,<span class="number">13</span>) ^ rol(x,<span class="number">23</span>))  <span class="comment"># used on Ï„(x)</span></span><br><span class="line">T_key = <span class="keyword">lambda</span> x: T_(Ï„(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key_schedule</span>(<span class="params">master_key: <span class="built_in">bytes</span>, nr: <span class="built_in">int</span>=<span class="number">32</span></span>):</span><br><span class="line">    K = [b2l(master_key[i:i+<span class="number">4</span>]) ^ FK[i//<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">16</span>,<span class="number">4</span>)]</span><br><span class="line">    rks = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nr):</span><br><span class="line">        Ki = K[i] ^ T_key(CK[i] ^ K[i+<span class="number">1</span>] ^ K[i+<span class="number">2</span>] ^ K[i+<span class="number">3</span>])</span><br><span class="line">        K.append(Ki)</span><br><span class="line">        rks.append(Ki)</span><br><span class="line">    <span class="keyword">return</span> rks</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€  2^16 ç»“æ„</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_block</span>(<span class="params">a: <span class="built_in">int</span>, d: <span class="built_in">int</span>, base=(<span class="params"><span class="number">0x11223344</span>,<span class="number">0x55667788</span>,<span class="number">0x99aabbcc</span>,<span class="number">0xddeeff00</span></span>), active_byte_index=<span class="number">3</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="comment"># Î”(a) = L(0,0,0,a) âŠ• base[0]</span></span><br><span class="line">    shift = (<span class="number">3</span> - active_byte_index) * <span class="number">8</span></span><br><span class="line">    w = (a &amp; <span class="number">0xFF</span>) &lt;&lt; shift</span><br><span class="line">    W1 = L(w) ^ base[<span class="number">0</span>]</span><br><span class="line">    m = (d &amp; <span class="number">0xFF</span>) &lt;&lt; shift</span><br><span class="line">    W2 = base[<span class="number">1</span>] ^ m</span><br><span class="line">    W3 = base[<span class="number">2</span>] ^ m</span><br><span class="line">    W4 = base[<span class="number">3</span>] ^ m</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join(l2b(x) <span class="keyword">for</span> x <span class="keyword">in</span> (W1,W2,W3,W4))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEX_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;^[0-9a-fA-F]+$&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recv_hex_line</span>(<span class="params">io, timeout=<span class="number">5.0</span></span>):</span><br><span class="line">    line = io.recvline(timeout=timeout)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">        <span class="keyword">raise</span> EOFError(<span class="string">&quot;No line from oracle&quot;</span>)</span><br><span class="line">    s = line.strip().decode()</span><br><span class="line">    <span class="comment"># Some servers may print banners; skip non-hex lines</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> HEX_RE.<span class="keyword">match</span>(s):</span><br><span class="line">        line = io.recvline(timeout=timeout)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">raise</span> EOFError(<span class="string">&quot;No hex line from oracle&quot;</span>)</span><br><span class="line">        s = line.strip().decode()</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_pt_get_ct</span>(<span class="params">io, pt_hex: <span class="built_in">str</span>, expect_prompt=<span class="literal">True</span>, timeout=<span class="number">5.0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> expect_prompt:</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, pt_hex.encode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(pt_hex.encode())</span><br><span class="line">    <span class="keyword">return</span> recv_hex_line(io, timeout=timeout)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_base_collect</span>(<span class="params">io: remote, base, active_byte_index=<span class="number">3</span>, expect_prompt=<span class="literal">True</span></span>):</span><br><span class="line">    sum_C0 = <span class="number">0</span></span><br><span class="line">    U_cols = [[],[],[],[]]</span><br><span class="line">    <span class="comment"># 65,536 queries</span></span><br><span class="line">    </span><br><span class="line">    ptl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            pt = build_block(a, d, base=base, active_byte_index=active_byte_index)</span><br><span class="line">            ptl[a*<span class="number">256</span> + d] = pt.<span class="built_in">hex</span>()</span><br><span class="line">    ctl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">    </span><br><span class="line">    gap = <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">0</span>, <span class="number">256</span> * <span class="number">256</span>, gap):</span><br><span class="line">        io.send((<span class="string">&quot;\n&quot;</span>.join(ptl[i:i+gap]) + <span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">        recv = io.recvlines(gap)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(gap):</span><br><span class="line">            ctl[i + j] = recv[j].split(<span class="string">b&quot; &quot;</span>)[<span class="number">1</span>].decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            pt = <span class="built_in">bytes</span>.fromhex(ptl[a*<span class="number">256</span> + d])</span><br><span class="line">            ct = <span class="built_in">bytes</span>.fromhex(ctl[a*<span class="number">256</span> + d])</span><br><span class="line">            C0 = b2l(ct[<span class="number">0</span>:<span class="number">4</span>]); C1 = b2l(ct[<span class="number">4</span>:<span class="number">8</span>]); C2 = b2l(ct[<span class="number">8</span>:<span class="number">12</span>]); C3 = b2l(ct[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">            sum_C0 ^= C0</span><br><span class="line">            U = C3 ^ C2 ^ C1</span><br><span class="line">            Ub = l2b(U)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                U_cols[i].append(Ub[i])</span><br><span class="line">    t = L_inv(sum_C0)</span><br><span class="line">    <span class="keyword">return</span> t, U_cols</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·²ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recover_k13_from_oracle_and_intersect</span>(<span class="params">io, bases, active_byte_index=<span class="number">3</span>, expect_prompt=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="comment"># For each base, compute candidate sets per byte</span></span><br><span class="line">    cand_sets = [<span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">256</span>)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(bases) = &#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> base <span class="keyword">in</span> bases:</span><br><span class="line">        t, U_cols = query_base_collect(io, base, active_byte_index, expect_prompt=expect_prompt)</span><br><span class="line">        t_b = l2b(t)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] base=<span class="subst">&#123;<span class="built_in">tuple</span>(<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> base)&#125;</span> -&gt; t=0x<span class="subst">&#123;t:08x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> bpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_cand = <span class="built_in">set</span>()</span><br><span class="line">            col = U_cols[bpos]</span><br><span class="line">            want = t_b[bpos]</span><br><span class="line">            <span class="keyword">for</span> g <span class="keyword">in</span> cand_sets[bpos]:</span><br><span class="line">                acc = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> v <span class="keyword">in</span> col:</span><br><span class="line">                    acc ^= S[v ^ g]</span><br><span class="line">                <span class="keyword">if</span> acc == want:</span><br><span class="line">                    new_cand.add(g)</span><br><span class="line">            cand_sets[bpos] = new_cand</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cand_sets[bpos]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[oracle] byte[<span class="subst">&#123;bpos&#125;</span>] å€™é€‰ä¸ºç©ºï¼Œéœ€å¢åŠ æ›´å¤šåŸºåº•&quot;</span>)</span><br><span class="line">    rec = [<span class="built_in">min</span>(cs) <span class="keyword">if</span> cs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> cs <span class="keyword">in</span> cand_sets]</span><br><span class="line">    <span class="keyword">for</span> i,cs <span class="keyword">in</span> <span class="built_in">enumerate</span>(cand_sets):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cs)&gt;<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[oracle] byte[<span class="subst">&#123;i&#125;</span>] å¤šè§£ <span class="subst">&#123;<span class="built_in">sorted</span>(<span class="built_in">map</span>(<span class="built_in">hex</span>,cs))&#125;</span>ï¼Œå–æœ€å° <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] byte[<span class="subst">&#123;i&#125;</span>] = <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b2l(<span class="built_in">bytes</span>(rec))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·²ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recover_k12_with_k13</span>(<span class="params">io, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="comment"># Recover last round of 9-round using known K13</span></span><br><span class="line">    cand_sets = [<span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">256</span>)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(bases) = &#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> base <span class="keyword">in</span> bases:</span><br><span class="line">        sum_X12 = <span class="number">0</span></span><br><span class="line">        U_cols = [[],[],[],[]]</span><br><span class="line"></span><br><span class="line">        ptl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = build_block(a, d, base=base, active_byte_index=active_byte_index)</span><br><span class="line">                ptl[a*<span class="number">256</span> + d] = pt.<span class="built_in">hex</span>()</span><br><span class="line">        ctl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        </span><br><span class="line">        gap = <span class="number">32</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">0</span>, <span class="number">256</span> * <span class="number">256</span>, gap):</span><br><span class="line">            io.send((<span class="string">&quot;\n&quot;</span>.join(ptl[i:i+gap]) + <span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">            recv = io.recvlines(gap)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(gap):</span><br><span class="line">                ctl[i + j] = recv[j].split(<span class="string">b&quot; &quot;</span>)[<span class="number">1</span>].decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = <span class="built_in">bytes</span>.fromhex(ptl[a*<span class="number">256</span> + d])</span><br><span class="line">                ct = <span class="built_in">bytes</span>.fromhex(ctl[a*<span class="number">256</span> + d])</span><br><span class="line">                X13 = b2l(ct[<span class="number">0</span>:<span class="number">4</span>]); X12 = b2l(ct[<span class="number">4</span>:<span class="number">8</span>]); X11 = b2l(ct[<span class="number">8</span>:<span class="number">12</span>]); X10 = b2l(ct[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">                U10 = X10 ^ X11 ^ X12</span><br><span class="line">                X9 = X13 ^ T(U10 ^ K13)</span><br><span class="line">                <span class="comment"># 9-round target sums S9,4 = X12</span></span><br><span class="line">                sum_X12 ^= X12</span><br><span class="line">                <span class="comment"># 9-round U = X9 ^ X10 ^ X11</span></span><br><span class="line">                U9 = X9 ^ X10 ^ X11</span><br><span class="line">                Ub = l2b(U9)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                    U_cols[i].append(Ub[i])</span><br><span class="line">        t9 = L_inv(sum_X12)</span><br><span class="line">        t9_b = l2b(t9)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K13 known) base=<span class="subst">&#123;<span class="built_in">tuple</span>(<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> base)&#125;</span> -&gt; t9=0x<span class="subst">&#123;t9:08x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> bpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_cand = <span class="built_in">set</span>()</span><br><span class="line">            col = U_cols[bpos]</span><br><span class="line">            want = t9_b[bpos]</span><br><span class="line">            <span class="keyword">for</span> g <span class="keyword">in</span> cand_sets[bpos]:</span><br><span class="line">                acc = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> v <span class="keyword">in</span> col:</span><br><span class="line">                    acc ^= S[v ^ g]</span><br><span class="line">                <span class="keyword">if</span> acc == want:</span><br><span class="line">                    new_cand.add(g)</span><br><span class="line">            cand_sets[bpos] = new_cand</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cand_sets[bpos]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K13) byte[<span class="subst">&#123;bpos&#125;</span>] å€™é€‰ä¸ºç©ºï¼Œéœ€è¦æ›´å¤šåŸºåº•&quot;</span>)</span><br><span class="line">    rec = [<span class="built_in">min</span>(cs) <span class="keyword">if</span> cs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> cs <span class="keyword">in</span> cand_sets]</span><br><span class="line">    <span class="keyword">for</span> i,cs <span class="keyword">in</span> <span class="built_in">enumerate</span>(cand_sets):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cs)&gt;<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K13) byte[<span class="subst">&#123;i&#125;</span>] å¤šè§£ <span class="subst">&#123;<span class="built_in">sorted</span>(<span class="built_in">map</span>(<span class="built_in">hex</span>,cs))&#125;</span>ï¼Œå–æœ€å° <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K13) byte[<span class="subst">&#123;i&#125;</span>] = <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b2l(<span class="built_in">bytes</span>(rec))</span><br><span class="line"></span><br><span class="line"><span class="comment"># # å·²ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recover_k11_with_k12_k13</span>(<span class="params">io, K12, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="comment"># Recover last round of 8-round using known K12,K13</span></span><br><span class="line">    cand_sets = [<span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">256</span>)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> base <span class="keyword">in</span> bases:</span><br><span class="line">        sum_X11 = <span class="number">0</span></span><br><span class="line">        U_cols = [[],[],[],[]]</span><br><span class="line"></span><br><span class="line">        ptl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = build_block(a, d, base=base, active_byte_index=active_byte_index)</span><br><span class="line">                ptl[a*<span class="number">256</span> + d] = pt.<span class="built_in">hex</span>()</span><br><span class="line">        ctl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        </span><br><span class="line">        gap = <span class="number">32</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">0</span>, <span class="number">256</span> * <span class="number">256</span>, gap):</span><br><span class="line">            io.send((<span class="string">&quot;\n&quot;</span>.join(ptl[i:i+gap]) + <span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">            recv = io.recvlines(gap)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(gap):</span><br><span class="line">                ctl[i + j] = recv[j].split(<span class="string">b&quot; &quot;</span>)[<span class="number">1</span>].decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = <span class="built_in">bytes</span>.fromhex(ptl[a*<span class="number">256</span> + d])</span><br><span class="line">                ct = <span class="built_in">bytes</span>.fromhex(ctl[a*<span class="number">256</span> + d])</span><br><span class="line">                X13 = b2l(ct[<span class="number">0</span>:<span class="number">4</span>]); X12 = b2l(ct[<span class="number">4</span>:<span class="number">8</span>]); X11 = b2l(ct[<span class="number">8</span>:<span class="number">12</span>]); X10 = b2l(ct[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">                <span class="comment"># step back to X9 with K13</span></span><br><span class="line">                U10 = X10 ^ X11 ^ X12</span><br><span class="line">                X9 = X13 ^ T(U10 ^ K13)</span><br><span class="line">                <span class="comment"># step back to X8 with K12</span></span><br><span class="line">                U9 = X9 ^ X10 ^ X11</span><br><span class="line">                X8 = X12 ^ T(U9 ^ K12)</span><br><span class="line">                <span class="comment"># 8-round target S8,4 = X11</span></span><br><span class="line">                sum_X11 ^= X11</span><br><span class="line">                <span class="comment"># 8-round U = X8 ^ X9 ^ X10</span></span><br><span class="line">                U8 = X8 ^ X9 ^ X10</span><br><span class="line">                Ub = l2b(U8)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                    U_cols[i].append(Ub[i])</span><br><span class="line">        t8 = L_inv(sum_X11)</span><br><span class="line">        t8_b = l2b(t8)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K12,K13 known) base=<span class="subst">&#123;<span class="built_in">tuple</span>(<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> base)&#125;</span> -&gt; t8=0x<span class="subst">&#123;t8:08x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> bpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_cand = <span class="built_in">set</span>()</span><br><span class="line">            col = U_cols[bpos]</span><br><span class="line">            want = t8_b[bpos]</span><br><span class="line">            <span class="keyword">for</span> g <span class="keyword">in</span> cand_sets[bpos]:</span><br><span class="line">                acc = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> v <span class="keyword">in</span> col:</span><br><span class="line">                    acc ^= S[v ^ g]</span><br><span class="line">                <span class="keyword">if</span> acc == want:</span><br><span class="line">                    new_cand.add(g)</span><br><span class="line">            cand_sets[bpos] = new_cand</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cand_sets[bpos]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K12,K13) byte[<span class="subst">&#123;bpos&#125;</span>] å€™é€‰ä¸ºç©ºï¼Œéœ€è¦æ›´å¤šåŸºåº•&quot;</span>)</span><br><span class="line">    rec = [<span class="built_in">min</span>(cs) <span class="keyword">if</span> cs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> cs <span class="keyword">in</span> cand_sets]</span><br><span class="line">    <span class="keyword">for</span> i,cs <span class="keyword">in</span> <span class="built_in">enumerate</span>(cand_sets):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cs)&gt;<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K12,K13) byte[<span class="subst">&#123;i&#125;</span>] å¤šè§£ <span class="subst">&#123;<span class="built_in">sorted</span>(<span class="built_in">map</span>(<span class="built_in">hex</span>,cs))&#125;</span>ï¼Œå–æœ€å° <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K12,K13) byte[<span class="subst">&#123;i&#125;</span>] = <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b2l(<span class="built_in">bytes</span>(rec))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recover_k10_with_k11_k12_k13</span>(<span class="params">io, K11, K12, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="comment"># Recover last round of 7-round using known K11,K12,K13</span></span><br><span class="line">    cand_sets = [<span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">256</span>)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> base <span class="keyword">in</span> bases:</span><br><span class="line">        sum_X10 = <span class="number">0</span></span><br><span class="line">        U_cols = [[],[],[],[]]</span><br><span class="line"></span><br><span class="line">        ptl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = build_block(a, d, base=base, active_byte_index=active_byte_index)</span><br><span class="line">                ptl[a*<span class="number">256</span> + d] = pt.<span class="built_in">hex</span>()</span><br><span class="line">        ctl = [<span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span> * <span class="number">256</span>)]</span><br><span class="line">        </span><br><span class="line">        gap = <span class="number">32</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">0</span>, <span class="number">256</span> * <span class="number">256</span>, gap):</span><br><span class="line">            io.send((<span class="string">&quot;\n&quot;</span>.join(ptl[i:i+gap]) + <span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">            recv = io.recvlines(gap)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(gap):</span><br><span class="line">                ctl[i + j] = recv[j].split(<span class="string">b&quot; &quot;</span>)[<span class="number">1</span>].decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                pt = <span class="built_in">bytes</span>.fromhex(ptl[a*<span class="number">256</span> + d])</span><br><span class="line">                ct = <span class="built_in">bytes</span>.fromhex(ctl[a*<span class="number">256</span> + d])</span><br><span class="line">                X13 = b2l(ct[<span class="number">0</span>:<span class="number">4</span>]); X12 = b2l(ct[<span class="number">4</span>:<span class="number">8</span>]); X11 = b2l(ct[<span class="number">8</span>:<span class="number">12</span>]); X10 = b2l(ct[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">                <span class="comment"># X9</span></span><br><span class="line">                U10 = X10 ^ X11 ^ X12</span><br><span class="line">                X9 = X13 ^ T(U10 ^ K13)</span><br><span class="line">                <span class="comment"># X8</span></span><br><span class="line">                U9 = X9 ^ X10 ^ X11</span><br><span class="line">                X8 = X12 ^ T(U9 ^ K12)</span><br><span class="line">                <span class="comment"># X7</span></span><br><span class="line">                U8 = X8 ^ X9 ^ X10</span><br><span class="line">                X7 = X11 ^ T(U8 ^ K11)</span><br><span class="line">                <span class="comment"># 7-round target S7,4 = X10</span></span><br><span class="line">                sum_X10 ^= X10</span><br><span class="line">                <span class="comment"># 7-round U = X7 ^ X8 ^ X9</span></span><br><span class="line">                U7 = X7 ^ X8 ^ X9</span><br><span class="line">                Ub = l2b(U7)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                    U_cols[i].append(Ub[i])</span><br><span class="line">        t7 = L_inv(sum_X10)</span><br><span class="line">        t7_b = l2b(t7)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K11..K13 known) base=<span class="subst">&#123;<span class="built_in">tuple</span>(<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> base)&#125;</span> -&gt; t7=0x<span class="subst">&#123;t7:08x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> bpos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_cand = <span class="built_in">set</span>()</span><br><span class="line">            col = U_cols[bpos]</span><br><span class="line">            want = t7_b[bpos]</span><br><span class="line">            <span class="keyword">for</span> g <span class="keyword">in</span> cand_sets[bpos]:</span><br><span class="line">                acc = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> v <span class="keyword">in</span> col:</span><br><span class="line">                    acc ^= S[v ^ g]</span><br><span class="line">                <span class="keyword">if</span> acc == want:</span><br><span class="line">                    new_cand.add(g)</span><br><span class="line">            cand_sets[bpos] = new_cand</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cand_sets[bpos]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K11..K13) byte[<span class="subst">&#123;bpos&#125;</span>] å€™é€‰ä¸ºç©ºï¼Œéœ€è¦æ›´å¤šåŸºåº•&quot;</span>)</span><br><span class="line">    rec = [<span class="built_in">min</span>(cs) <span class="keyword">if</span> cs <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> cs <span class="keyword">in</span> cand_sets]</span><br><span class="line">    <span class="keyword">for</span> i,cs <span class="keyword">in</span> <span class="built_in">enumerate</span>(cand_sets):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(cs)&gt;<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K11..K13) byte[<span class="subst">&#123;i&#125;</span>] å¤šè§£ <span class="subst">&#123;<span class="built_in">sorted</span>(<span class="built_in">map</span>(<span class="built_in">hex</span>,cs))&#125;</span>ï¼Œå–æœ€å° <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[oracle] (K11..K13) byte[<span class="subst">&#123;i&#125;</span>] = <span class="subst">&#123;rec[i]:#04x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b2l(<span class="built_in">bytes</span>(rec))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_master_from_k10_13</span>(<span class="params">K10,K11,K12,K13</span>):</span><br><span class="line">    <span class="comment"># Recreate K[0..13] backwards</span></span><br><span class="line">    K = [<span class="number">0</span>]*<span class="number">14</span></span><br><span class="line">    K[<span class="number">10</span>],K[<span class="number">11</span>],K[<span class="number">12</span>],K[<span class="number">13</span>] = K10,K11,K12,K13</span><br><span class="line">    <span class="comment"># invert recurrence: K[i] = K[i+4] ^ T_key(CK[i] ^ K[i+1] ^ K[i+2] ^ K[i+3])</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        K[i] = K[i+<span class="number">4</span>] ^ T_key(CK[i] ^ K[i+<span class="number">1</span>] ^ K[i+<span class="number">2</span>] ^ K[i+<span class="number">3</span>])</span><br><span class="line">    <span class="comment"># master key words = K[0..3] ^ FK</span></span><br><span class="line">    w0 = K[<span class="number">0</span>] ^ FK[<span class="number">0</span>]; w1 = K[<span class="number">1</span>] ^ FK[<span class="number">1</span>]; w2 = K[<span class="number">2</span>] ^ FK[<span class="number">2</span>]; w3 = K[<span class="number">3</span>] ^ FK[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(l2b(w) <span class="keyword">for</span> w <span class="keyword">in</span> (w0,w1,w2,w3))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decryption utilities to verify end-to-end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc_block_with_roundkeys</span>(<span class="params">block_words, rk</span>):</span><br><span class="line">    X = <span class="built_in">list</span>(block_words)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rk)):</span><br><span class="line">        X.append(X[i] ^ T(X[i+<span class="number">1</span>] ^ X[i+<span class="number">2</span>] ^ X[i+<span class="number">3</span>] ^ rk[i]))</span><br><span class="line">    <span class="keyword">return</span> (X[<span class="built_in">len</span>(rk)], X[<span class="built_in">len</span>(rk)+<span class="number">1</span>], X[<span class="built_in">len</span>(rk)+<span class="number">2</span>], X[<span class="built_in">len</span>(rk)+<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec_block</span>(<span class="params">key, block, nr=<span class="number">32</span></span>):</span><br><span class="line">    rks = key_schedule(key, nr)</span><br><span class="line">    X = [b2l(block[i:i+<span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">16</span>,<span class="number">4</span>)]</span><br><span class="line">    <span class="comment"># produce reversed rounds by feeding rk in reverse</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nr):</span><br><span class="line">        X.append(X[i] ^ T(X[i+<span class="number">1</span>] ^ X[i+<span class="number">2</span>] ^ X[i+<span class="number">3</span>] ^ rks[nr-<span class="number">1</span>-i]))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(l2b(X[nr+<span class="number">3</span> - i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec_cbc_zero_iv</span>(<span class="params">key, ct</span>):</span><br><span class="line">    <span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line">    <span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor <span class="keyword">as</span> bxor</span><br><span class="line">    iv = <span class="built_in">bytes</span>(<span class="number">16</span>)</span><br><span class="line">    pt = <span class="string">b&quot;&quot;</span></span><br><span class="line">    prev = iv</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(ct), <span class="number">16</span>):</span><br><span class="line">        block = ct[i:i+<span class="number">16</span>]</span><br><span class="line">        m = dec_block(key, block, <span class="number">32</span>)</span><br><span class="line">        m = bxor(m, prev)</span><br><span class="line">        pt += m</span><br><span class="line">        prev = block</span><br><span class="line">    <span class="keyword">return</span> unpad(pt, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    bases = [</span><br><span class="line">        (<span class="number">0x11223344</span>,<span class="number">0x55667788</span>,<span class="number">0x99aabbcc</span>,<span class="number">0xddeeff00</span>),</span><br><span class="line">        (<span class="number">0x01020304</span>,<span class="number">0x05060708</span>,<span class="number">0x0a0b0c0d</span>,<span class="number">0x0e0f1011</span>),</span><br><span class="line">        (<span class="number">0x89abcdef</span>,<span class="number">0x01234567</span>,<span class="number">0xfedcba98</span>,<span class="number">0x76543210</span>),</span><br><span class="line">    ]</span><br><span class="line">    expect_prompt = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># io = remote(&quot;60.205.163.215&quot;, 51556)</span></span><br><span class="line">    io = process([<span class="string">&quot;python&quot;</span>, <span class="string">&quot;/d/CTF/Chall/2025/N1junior_2/SM4/attachment/server.py&quot;</span>])</span><br><span class="line">    flag_ct_hex = io.recvline().strip().decode()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] 32-round FLAG ct = <span class="subst">&#123;flag_ct_hex&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recover K13 with intersection</span></span><br><span class="line">    K13 = recover_k13_from_oracle_and_intersect(io, bases, active_byte_index=<span class="number">3</span>, expect_prompt=expect_prompt)</span><br><span class="line">    K13 = recover_k13_from_oracle_and_intersect(io, bases, active_byte_index=<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] K13 = 0x<span class="subst">&#123;K13:08x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recover K12 using virtual 9-round</span></span><br><span class="line">    K12 = recover_k12_with_k13(io, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=expect_prompt)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] K12 = 0x<span class="subst">&#123;K12:08x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recover K11, K10</span></span><br><span class="line">    K11 = recover_k11_with_k12_k13(io, K12, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=expect_prompt)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] K11 = 0x<span class="subst">&#123;K11:08x&#125;</span>&quot;</span>)</span><br><span class="line">    K10 = recover_k10_with_k11_k12_k13(io, K11, K12, K13, bases, active_byte_index=<span class="number">3</span>, expect_prompt=expect_prompt)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] K10 = 0x<span class="subst">&#123;K10:08x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reverse to master key</span></span><br><span class="line">    master_key = reverse_master_from_k10_13(K10,K11,K12,K13)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] recovered master key = <span class="subst">&#123;master_key.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use recovered master key to decrypt FLAG</span></span><br><span class="line">    flag_ct = <span class="built_in">bytes</span>.fromhex(flag_ct_hex)</span><br><span class="line">    rec_flag = dec_cbc_zero_iv(master_key, flag_ct)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] FLAG (recovered key): <span class="subst">&#123;rec_flag.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For verification compute true keys</span></span><br><span class="line">    true_master = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0123456789abcdeffedcba9876543210&quot;</span>)</span><br><span class="line">    true_rks = key_schedule(true_master, <span class="number">32</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[oracle] true K10..K13 = 0x<span class="subst">&#123;true_rks[<span class="number">7</span>]:08x&#125;</span>,0x<span class="subst">&#123;true_rks[<span class="number">8</span>]:08x&#125;</span>,0x<span class="subst">&#123;true_rks[<span class="number">9</span>]:08x&#125;</span>,0x<span class="subst">&#123;true_rks[<span class="number">10</span>]:08x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    io.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="references">References</h3>
<section id="references">
<ol class="refs">
<li id="ref-1" data-label="[1]">
<a target="_blank" rel="noopener" href="https://eprint.iacr.org/2025/306.pdf"> A. Joux, J. Loss, and G.
Santato, â€œDimensional eROSion: Improving the ROS Attack with
Decomposition in Higher Bases,â€ Cryptology ePrint Archive, Paper
2025/306, 2025. </a>
<a href="#cite-1a" class="backref" aria-label="è¿”å›æ–‡ä¸­">â†©ï¸ï¸</a>
</li>
<li id="ref-2" data-label="[2]">
<a target="_blank" rel="noopener" href="https://archive.ymsc.tsinghua.edu.cn/pacm_download/672/12608-dingjt-c15.pdf">
F. Liu et al., â€œAnalysis of the SMS4 Block Cipher,â€ in Proc. 12th
Australasian Conf. on Information Security and Privacy (ACISP 2007),
Lecture Notes in Computer Science, vol. 4586, J. Pieprzyk, H. Ghodosi,
and E. Dawson, Eds. Berlin, Heidelberg: Springer-Verlag, 2007, pp.
158â€“170. </a>
<a href="#cite-2a" class="backref" aria-label="è¿”å›æ–‡ä¸­">â†©ï¸ï¸</a>
</li>
</ol>
</section>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>FariTree
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/" title="N1junior2025-Crypto-WP">http://faritree.top/2025/09/15/N1junior2025-Crypto-WP/</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/07/28/NepCTF2025-Crypto-WP/" rel="prev" title="NepCTF2025-Crypto-WP">
                  <i class="fa fa-angle-left"></i> NepCTF2025-Crypto-WP
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/10/15/H3CTF2025-Crypto-WP/" rel="next" title="H3CTF2025-Crypto-WP">
                  H3CTF2025-Crypto-WP <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">FariTree</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>





</body>
</html>
