<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/Default_Emote-Thumbs_Up.png">
  <link rel="mask-icon" href="/images/Default_Emote-Thumbs_Up.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":2,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="赛中只写了Crypto部分，最终排名No.10。">
<meta property="og:type" content="article">
<meta property="og:title" content="NepCTF2025-Crypto-WP">
<meta property="og:url" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/index.html">
<meta property="og:site_name" content="FariTree&#39;s Blog">
<meta property="og:description" content="赛中只写了Crypto部分，最终排名No.10。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/1.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/3.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/2.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/handshake.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/g1.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/g2.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/g3.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/g4.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/signature.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/signature_asn1.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/sign_process.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/ID_A_default.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/client_key_exchange.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/cipher_structure.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/SM2_encrypto.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/master-secret.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/PRF.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/work_secret.png">
<meta property="og:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/Finished.png">
<meta property="article:published_time" content="2025-07-28T01:09:47.000Z">
<meta property="article:modified_time" content="2025-07-31T06:56:04.971Z">
<meta property="article:author" content="FariTree">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="侧信道">
<meta property="article:tag" content="HNP">
<meta property="article:tag" content="GMSSL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/1.png">


<link rel="canonical" href="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/07/28/NepCTF2025-Crypto-WP/","path":"2025/07/28/NepCTF2025-Crypto-WP/","title":"NepCTF2025-Crypto-WP"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NepCTF2025-Crypto-WP | FariTree's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">FariTree's Blog</p>
      <i class="logo-line"></i>
    </a>
      <img class="custom-logo-image" src="/images/Default_Emote-Thumbs_Up.png" alt="FariTree's Blog">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#nepsign"><span class="nav-number">1.</span> <span class="nav-text">Nepsign</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="nav-number">1.1.</span> <span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp"><span class="nav-number">1.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#latticebros"><span class="nav-number">2.</span> <span class="nav-text">latticebros</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="nav-number">2.1.</span> <span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-1"><span class="nav-number">2.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ezrsa2"><span class="nav-number">3.</span> <span class="nav-text">ezRSA2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-2"><span class="nav-number">3.1.</span> <span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-2"><span class="nav-number">3.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#transistion"><span class="nav-number">4.</span> <span class="nav-text">transistion</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-3"><span class="nav-number">4.1.</span> <span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-3"><span class="nav-number">4.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unloopshock"><span class="nav-number">5.</span> <span class="nav-text">unloopshock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-4"><span class="nav-number">5.1.</span> <span class="nav-text">解题思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exp-4"><span class="nav-number">5.2.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BD%E4%BA%A7%E5%AF%86%E7%A0%81%E5%BA%94%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">*国产密码应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-5"><span class="nav-number">6.1.</span> <span class="nav-text">解题思路</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%AD%BE%E5%90%8D%E7%A7%81%E9%92%A5"><span class="nav-number">6.1.1.</span> <span class="nav-text">获取签名私钥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E9%80%9A%E4%BF%A1%E6%B5%81%E9%87%8F"><span class="nav-number">6.1.2.</span> <span class="nav-text">解密通信流量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84sm2"><span class="nav-number">6.1.3.</span> <span class="nav-text">最后的SM2</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">FariTree</p>
  <div class="site-description" itemprop="description">我好菜啊</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FariTree">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FariTree's Blog">
      <meta itemprop="description" content="我好菜啊">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="NepCTF2025-Crypto-WP | FariTree's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          NepCTF2025-Crypto-WP
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-07-28 09:09:47" itemprop="dateCreated datePublished" datetime="2025-07-28T09:09:47+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-31 14:56:04" itemprop="dateModified" datetime="2025-07-31T14:56:04+08:00">2025-07-31</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>赛中只写了Crypto部分，最终排名No.10。</p>
<span id="more"></span>
<p>本次比赛有些题目比较特别，总体感觉是挺有趣的。</p>
<h3 id="nepsign">Nepsign</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">来签个名吧！flag格式为NepCTF&#123;xxx&#125;</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="Nepsign.zip">Nepsign.zip</a></p>
<h4 id="解题思路">解题思路</h4>
<p>签名由48个哈希值组成，当私钥相同时，每个位置的哈希值只与当前位置<span class="math inline">\(i\)</span>和<span class="math inline">\(step[i]\)</span>有关，<span class="math inline">\(step[i]\)</span>由签名的消息确定。所以先求出<code>happy for NepCTF 2025</code>的<span class="math inline">\(step\)</span>，然后随机选取一些消息发送给服务器，从返回的签名中拿到<span class="math inline">\((i,
step[i])\)</span>对应的哈希值，需要的签名都拿到后，发给服务器就行。</p>
<h4 id="exp">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote</span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM3</span>(<span class="params">data</span>):</span><br><span class="line">    d = [i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    h = sm3.sm3_hash(d)</span><br><span class="line">    <span class="keyword">return</span> h</span><br><span class="line"></span><br><span class="line">step = [<span class="number">133</span>, <span class="number">173</span>, <span class="number">19</span>, <span class="number">145</span>, <span class="number">60</span>, <span class="number">63</span>, <span class="number">104</span>, <span class="number">221</span>, <span class="number">135</span>, <span class="number">205</span>, <span class="number">35</span>, <span class="number">251</span>, <span class="number">11</span>, <span class="number">191</span>, <span class="number">48</span>, <span class="number">240</span>, <span class="number">88</span>, <span class="number">181</span>, <span class="number">216</span>, <span class="number">241</span>, <span class="number">218</span>, <span class="number">121</span>, <span class="number">210</span>, <span class="number">108</span>, <span class="number">166</span>, <span class="number">236</span>, <span class="number">59</span>, <span class="number">171</span>, <span class="number">38</span>, <span class="number">144</span>, <span class="number">58</span>, <span class="number">168</span>, <span class="number">147</span>, <span class="number">53</span>, <span class="number">124</span>, <span class="number">191</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">168</span>, <span class="number">61</span>, <span class="number">168</span>, <span class="number">110</span>, <span class="number">19</span>, <span class="number">222</span>, <span class="number">129</span>, <span class="number">178</span>, <span class="number">51</span>, <span class="number">133</span>]</span><br><span class="line">step1 = <span class="built_in">set</span>([(i, a)<span class="keyword">for</span> i, a <span class="keyword">in</span> <span class="built_in">enumerate</span>(step[:<span class="number">32</span>])])</span><br><span class="line">step2 = <span class="built_in">set</span>([(i, a)<span class="keyword">for</span> i, a <span class="keyword">in</span> <span class="built_in">enumerate</span>(step[<span class="number">32</span>:])])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_valid_msg</span>():</span><br><span class="line">    acquired1 = <span class="built_in">set</span>()</span><br><span class="line">    acquired2 = <span class="built_in">set</span>()</span><br><span class="line">    cnt1 = <span class="number">0</span></span><br><span class="line">    cnt2 = <span class="number">0</span></span><br><span class="line">    valid_msg = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        msg = os.urandom(<span class="number">32</span>)</span><br><span class="line">        hs = SM3(msg)</span><br><span class="line">        hb = <span class="built_in">bytes</span>.fromhex(hs)</span><br><span class="line">        valid = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            a = hb[i]</span><br><span class="line">            <span class="keyword">if</span> (i, a) <span class="keyword">in</span> step1 <span class="keyword">and</span> (i, a) <span class="keyword">not</span> <span class="keyword">in</span> acquired1:</span><br><span class="line">                valid = <span class="literal">True</span></span><br><span class="line">                cnt1 += <span class="number">1</span></span><br><span class="line">                acquired1.add((i, a))</span><br><span class="line">    </span><br><span class="line">        hex_symbols = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line">        <span class="built_in">sum</span> = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">65</span>):</span><br><span class="line">                <span class="keyword">if</span> hs[j - <span class="number">1</span>] == hex_symbols[i]:</span><br><span class="line">                    <span class="built_in">sum</span>[i] += j</span><br><span class="line">            a = <span class="built_in">sum</span>[i] % <span class="number">255</span></span><br><span class="line">            <span class="keyword">if</span> (i, a) <span class="keyword">in</span> step2 <span class="keyword">and</span> (i, a) <span class="keyword">not</span> <span class="keyword">in</span> acquired2:</span><br><span class="line">                valid = <span class="literal">True</span></span><br><span class="line">                cnt2 += <span class="number">1</span></span><br><span class="line">                acquired2.add((i, a))</span><br><span class="line">        <span class="keyword">if</span> valid:</span><br><span class="line">            valid_msg.append(msg)</span><br><span class="line">            <span class="comment"># print(f&quot;cnt1 = &#123;cnt1&#125;, cnt2 = &#123;cnt2&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> cnt1 == <span class="built_in">len</span>(step1) <span class="keyword">and</span> cnt2 == <span class="built_in">len</span>(step2):</span><br><span class="line">            <span class="keyword">break</span>    </span><br><span class="line">    <span class="keyword">return</span> valid_msg</span><br><span class="line"><span class="comment"># io = process([&quot;python&quot;, &quot;/d/CTF/Chall/2025/NepCTF/Nepsign/server.py&quot;], env=&#123;&quot;FLAG&quot;: &quot;NepCTF&#123;TEST_FLAG&#125;&quot;&#125;)</span></span><br><span class="line">io = remote(<span class="string">&quot;nepctf31-gntx-mv97-i9h2-9sccsetde288.nepctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">valid_msg = get_valid_msg()</span><br><span class="line">HashMap1 = <span class="built_in">dict</span>()</span><br><span class="line">HashMap2= <span class="built_in">dict</span>()</span><br><span class="line"><span class="keyword">for</span> msg <span class="keyword">in</span> tqdm(valid_msg):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;1\n&quot;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;msg: &quot;</span>, msg.<span class="built_in">hex</span>().encode() + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">    recvhash = <span class="built_in">eval</span>(io.recvline())</span><br><span class="line">    hs = SM3(msg)</span><br><span class="line">    hb = <span class="built_in">bytes</span>.fromhex(hs)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        a = hb[i]</span><br><span class="line">        <span class="keyword">if</span> (i, a) <span class="keyword">in</span> step1 <span class="keyword">and</span> (i, a) <span class="keyword">not</span> <span class="keyword">in</span> HashMap1.keys():</span><br><span class="line">            HashMap1.update(&#123;(i, a): recvhash[i]&#125;)</span><br><span class="line"></span><br><span class="line">    hex_symbols = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line">    <span class="built_in">sum</span> = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">65</span>):</span><br><span class="line">            <span class="keyword">if</span> hs[j - <span class="number">1</span>] == hex_symbols[i]:</span><br><span class="line">                <span class="built_in">sum</span>[i] += j</span><br><span class="line">        a = <span class="built_in">sum</span>[i] % <span class="number">255</span></span><br><span class="line">        <span class="keyword">if</span> (i, a) <span class="keyword">in</span> step2 <span class="keyword">and</span> (i, a) <span class="keyword">not</span> <span class="keyword">in</span> HashMap2.keys():</span><br><span class="line">            HashMap2.update(&#123;(i, a): recvhash[<span class="number">32</span> + i]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Sending signature...&quot;</span>)</span><br><span class="line">signature = [HashMap1[(i, a)] <span class="keyword">for</span> i, a <span class="keyword">in</span> [(i, a)<span class="keyword">for</span> i, a <span class="keyword">in</span> <span class="built_in">enumerate</span>(step[:<span class="number">32</span>])]] + [HashMap2[(i, a)] <span class="keyword">for</span> i, a <span class="keyword">in</span> [(i, a)<span class="keyword">for</span> i, a <span class="keyword">in</span> <span class="built_in">enumerate</span>(step[<span class="number">32</span>:])]]</span><br><span class="line">io.sendafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;2\n&quot;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&quot;give me a qq: &quot;</span>, <span class="built_in">str</span>(signature).encode() + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(io.recvuntil(<span class="string">b&quot;&gt;&quot;</span>).decode())</span><br><span class="line">io.close()</span><br><span class="line"><span class="comment"># NepCTF&#123;6575a53c-3e44-2b93-c17e-7610a1192514&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="latticebros">latticebros</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你能从给定的信息中找出隐藏的flag吗? flag格式为NepCTF&#123;xxx&#125;</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="LatticeBros.zip">LatticeBros.zip</a></p>
<h4 id="解题思路-1">解题思路</h4>
<p>已知： <span class="math display">\[
\alpha^3 + a_2\alpha^2 + a_1\alpha + a_0 = 0
\]</span> 这里<span class="math inline">\(a_i\)</span>都是整数，构造如下格：</p>
<p><span class="math display">\[
(1, a_2, a_1, a_0)
\begin{pmatrix}
\alpha^3C &amp; 1 &amp; 0 &amp; 0 \\
\alpha^2C &amp; 0 &amp; 1 &amp; 0 \\
\alpha C &amp; 0 &amp; 0 &amp; 1 \\
C &amp; 0 &amp; 0 &amp; 0 \\
\end{pmatrix}=(\epsilon C, 1,a_2, a_1)
\]</span></p>
<p>由于<span class="math inline">\(\alpha\)</span>精度有限，所以<span class="math inline">\(\epsilon\)</span>是一个非常接近0的数。<br>
求出<span class="math inline">\(a_2,
a_1\)</span>后代入原来的多项式得到<span class="math inline">\(a_0\)</span>。剩下的就是一个经典的HNP。</p>
<h4 id="exp-1">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.sage</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">data = [(<span class="number">541847931463604073209188621415697353813245102261880389530448</span>, <span class="number">293760933113243563398917466885108625646262447370201484418246</span>), (<span class="number">235213326900086489464935804156966465366154623411555613791270</span>, <span class="number">660823982268225103178763707015491421784294988488272636270997</span>), (<span class="number">826464884761457937459245903152143755707241416981488127320435</span>, <span class="number">428521663319038461250005113612781686761766888058391496085911</span>), (<span class="number">589542000504317435156560078533519448295689695687499354390208</span>, <span class="number">155284353896000150766154807679279597476176668344402166959399</span>), (<span class="number">968823371588600973965757332601758200815345862153455338808286</span>, <span class="number">870008943690791009196027169525956126827736285614393106689402</span>), (<span class="number">621636099728440147413990266662022925118216803638588918660041</span>, <span class="number">265635912066749696542909843111997941904342442664219734956888</span>), (<span class="number">426696569424050102229606043215592727790577655338668728275370</span>, <span class="number">279313121876980354011480010042682666651614765507190502627689</span>), (<span class="number">89450479064580125731654556963306718472532905610952012502649</span>, <span class="number">465933125964565419295325650759566635253450915499965633327941</span>), (<span class="number">480355476500393865742379469913983270769356894135485925662119</span>, <span class="number">894041172171871806404285309781862268351135623868845025443422</span>), (<span class="number">842436524669577199024236805258573090764419350786291073287889</span>, <span class="number">345478552143958037534551648319293899442551000874041707820740</span>), (<span class="number">650054674429185550652935714084022116516082323269321462104664</span>, <span class="number">441999979283903658157822753439653947343822546158589507765994</span>), (<span class="number">46289431385578693366971976442426853079852982529357847290686</span>, <span class="number">625618376463384339878849844467050454204685252824782609369180</span>), (<span class="number">71444185449163133531919043374545893927347050624346741281881</span>, <span class="number">955925578289311966288639224625142299309823207245807788495453</span>), (<span class="number">192579726169321656812883068526498248523814846320328766176253</span>, <span class="number">626481822474054336470183912297952839011392733501646931370367</span>), (<span class="number">736527635648804640774976580747540045854351230084566721853611</span>, <span class="number">276626211757586963928788091386096607703513204646314683038338</span>), (<span class="number">177922521867185878959621840269164617147915792720210315529733</span>, <span class="number">541058782621716573816245900423919799500476442285991532228641</span>), (<span class="number">40610451174818168154306630612571678739921107216052349044576</span>, <span class="number">727642592899858828601137105077611015328512898368636299587376</span>), (<span class="number">385012983728389322601149562441674995471397288632464238356283</span>, <span class="number">353921151307105661267278594470212933060655245893209524497156</span>), (<span class="number">750447975601038834764379841158092390933760641866111445401426</span>, <span class="number">391626416964965737035878375834907580903143512300198923948189</span>), (<span class="number">115058604943298010958881205548782439407592353731185670266593</span>, <span class="number">491630592857258949793489206081490523001249620510479961058022</span>), (<span class="number">327389234395954477946639629629085910688793716425320663599360</span>, <span class="number">24975272330009592102362429346350824580378490147041708568130</span>), (<span class="number">115595274689129534885608766476695918464309130165432995990883</span>, <span class="number">757961876891952019297626599379744405302595090402128271144165</span>), (<span class="number">950804723308776351161744501221236453742418549093165078282534</span>, <span class="number">20307246759635231945223392614290397512873344480184942904518</span>), (<span class="number">724537610412063699714461780160573528810830178440136810747811</span>, <span class="number">149681928388378582933943374524511804362928290938917573644613</span>), (<span class="number">340891278018589324130004945217960336392205386747747011263373</span>, <span class="number">683307718413135477104477081812052183267507312278283317237187</span>), (<span class="number">104379682905784169840335131193505192063050242530811180817410</span>, <span class="number">715010230598797717533306270232399781090458356371977748416491</span>), (<span class="number">644160326926600986730919713173510327120201404569141824224075</span>, <span class="number">127877985489410167008195578625004740882394608402141169695352</span>), (<span class="number">549253388716005399852261816416312267100135940382820676807345</span>, <span class="number">210560134643237517255193955173709174155305784935427470113433</span>), (<span class="number">968265711632086435506163736279856957220961064226797549228006</span>, <span class="number">273174723915971720522674140326199419265943707917542063022561</span>), (<span class="number">704367622558261900937184683100177434487519780290678439135652</span>, <span class="number">959106497548134540301589019840013331842784496835379005298630</span>)]</span><br><span class="line">alpha = <span class="number">54236.606188881754809671280151541781895183337725393</span></span><br><span class="line">d = <span class="number">981020902672546902438782010902608140583199504862558032616415</span></span><br><span class="line">alpha = QQ(alpha)</span><br><span class="line">M = matrix(QQ, [</span><br><span class="line">    [alpha**<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    [alpha**<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">    [alpha**<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">    [alpha**<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">])</span><br><span class="line">M[:, <span class="number">0</span>] *= getrandbits(<span class="number">32</span>)</span><br><span class="line">L = M.LLL()</span><br><span class="line">v = L[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> v[<span class="number">1</span>] == -<span class="number">1</span>:</span><br><span class="line">    v *= -<span class="number">1</span></span><br><span class="line">a2, a1 = v[<span class="number">2</span>], v[<span class="number">3</span>]</span><br><span class="line">a0 = -(alpha**<span class="number">3</span> + a2 * alpha**<span class="number">2</span> + a1 * alpha)</span><br><span class="line">p = d - <span class="built_in">int</span>(a0)</span><br><span class="line"></span><br><span class="line">al = []</span><br><span class="line">tl = []</span><br><span class="line"><span class="keyword">for</span> t, a <span class="keyword">in</span> data:</span><br><span class="line">    al.append(a)</span><br><span class="line">    tl.append(t)</span><br><span class="line">M = matrix(ZZ, [al, tl])</span><br><span class="line">M = M.stack(p * identity_matrix(ZZ, M.ncols()))</span><br><span class="line">L = M.LLL()</span><br><span class="line">beta = L[<span class="number">2</span>]</span><br><span class="line">b0, b1 = beta[<span class="number">0</span>], beta[<span class="number">1</span>]</span><br><span class="line">t0, t1 = tl[<span class="number">0</span>], tl[<span class="number">1</span>]</span><br><span class="line">a0, a1 = al[<span class="number">0</span>], al[<span class="number">1</span>]</span><br><span class="line">alpha = (b0 + a0) * <span class="built_in">pow</span>(t0, -<span class="number">1</span>, p) % p</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(alpha))</span><br><span class="line"><span class="comment"># NepCTF&#123;c0ngr4tv!at1Ons!!&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="ezrsa2">ezRSA2</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Easy RSA, easy strategy. No need to brute force.</span><br><span class="line">Perhaps it&#x27;s easier than ezRSA in NepCTF 2024.</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="ezrsa2.zip">ezrsa2.zip</a></p>
<h4 id="解题思路-2">解题思路</h4>
<p><span class="math inline">\(d \approx
N^{0.33}\)</span>，上界大于<span class="math inline">\(N^{0.292}\)</span>，但是给了<span class="math inline">\(d\)</span>的低位，可以用来优化。 已知： <span class="math display">\[
e(d_{m}M + d_{l}) = 1 + k(N - p - q + 1)
\]</span> 变形得： <span class="math display">\[
ed_{m}M = 1 + k(N - p - q + 1) - ed_{l}
\]</span> 令<span class="math inline">\(X = k, Y = p +
q\)</span>，然后在模<span class="math inline">\(eM\)</span>对如下多项式使用二元copper就行： <span class="math display">\[
f(X, Y) = 1 + X(N - Y + 1) - ed_{l}
\]</span></p>
<h4 id="exp-2">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.sage</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://github.com/defund/coppersmith</span></span><br><span class="line"><span class="keyword">from</span> sage.tools.coppersmith <span class="keyword">import</span> small_roots</span><br><span class="line"></span><br><span class="line">e=<span class="number">0x73915608ed64c9cf1a2279684cab4f4a78fba229d45d4f860971a241481363470a19cb0dc0d00f816b5befdaca017cf71483e96ef17b36179012f5194a0e6bf481bb06c2644f74c6812efb65d05c00631f282d6aa55c0bc140a1830b95a1cf4b6024cb0db53f2c2189897c41f22e2eec773723f531ec4bfa537fae6de5fe480cf46fe17850f7eb47df08194d95db3d26ac923b26e110ee645239ab586bbc546ddc5906f280a106edbb727ccb05536b5a3f5c0ebcf865c95ce58be54f7f3547aa53baa218b0dfa98e42d925fa341e45f94a3b16b0c83802660c7f34de3336cb21f219073cf8e9f5e39d47f0a9a9ee7c255f09a6add9a2f7a47960f4a853183d29</span></span><br><span class="line">N=<span class="number">0xba8956e81394f3f1265ca5d9c4ad1ab0078bb43c4b80a231ab2cc62246ae45f66a562252622aed2cbbfc08647ef2fec0f97a632bf2242845f4b3af0c427cec3d90f42e90278a5a0feeed0922a8cd2278074ac54e9cfc0e96ff68f8d8f266dd87dc1cc59c2895ec884de2022311767f6a9a7e0bd288c79620e28b83bb3c8d8ad1047c839d6ccf5544eaf434a5f00b951769ab3121298d04b63a162757beb3d49917cd0c9e02ee1ac29398c8130961d5a2f2833aba1e538edb7bb97071f40fae543d1622f0c9206c6d4d8abb2ac1b93ebfb603c2f3a909ede357ade4043550fe540d13a4e87db8d731fe130f15a43a1a00364f5da2d87f7b660c3a04e734218a11</span></span><br><span class="line">hints=[<span class="number">1</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">14</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">21</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">30</span>, <span class="number">38</span>, <span class="number">2</span>, <span class="number">20</span>, <span class="number">62</span>, <span class="number">66</span>, <span class="number">1</span>, <span class="number">22</span>, <span class="number">56</span>, <span class="number">41</span>, <span class="number">13</span>, <span class="number">78</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">6</span>, <span class="number">57</span>, <span class="number">117</span>, <span class="number">73</span>, <span class="number">75</span>, <span class="number">96</span>, <span class="number">112</span>, <span class="number">50</span>, <span class="number">93</span>, <span class="number">158</span>, <span class="number">97</span>, <span class="number">146</span>, <span class="number">8</span>, <span class="number">65</span>, <span class="number">96</span>, <span class="number">186</span>, <span class="number">161</span>, <span class="number">90</span>, <span class="number">131</span>, <span class="number">46</span>, <span class="number">32</span>, <span class="number">140</span>, <span class="number">133</span>, <span class="number">50</span>, <span class="number">43</span>, <span class="number">151</span>, <span class="number">234</span>]</span><br><span class="line">ct=<span class="number">0x101b284ad196b5bbd3d3df00a7d3577caeb29c681bdd122582b705afc671febf45d4f3786640e55aadd6a31ecc49175f97b772720f1735f8555f768b137a4643cd6958f80a3dfca4d0270ad463d6dde93429940bd2abb5ad8408b0906fa8d776544a1c50cc0d95939bef4c3fb64d0b52dca81ff0f244fc265bfc0bc147435d05f8f1a146e963a1403b3c123b4d6e73d1fd897109995009be1673212607f0ea7ae33d23f3158448b05c28ea6636382eee9436c4a6c09023ead7182ecd55ac73a68d458d726e1abc208810468591e63f4b4c2c1f3ce27c4800b52f7421ccab432c03e88b3b255740d719e40e0226eabb7633d97ed210e32071e2ac36ed17ef442e</span></span><br><span class="line"></span><br><span class="line">Ml = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(hints) + <span class="number">1</span>):</span><br><span class="line">    Ml.append(sieve_base[i])</span><br><span class="line">d_lsb = crt(hints, Ml)</span><br><span class="line">M = prod(Ml)</span><br><span class="line">PR.&lt;x, y&gt; = PolynomialRing(Zmod(e * M))</span><br><span class="line">f = <span class="number">1</span> - e*d_lsb + x*(N - y + <span class="number">1</span>)</span><br><span class="line">X = <span class="number">2</span>**<span class="number">680</span></span><br><span class="line">Y = <span class="number">2</span>**<span class="number">1024</span></span><br><span class="line">x0, y0 = small_roots(f, (X,Y), <span class="number">6</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">x0, y0 = <span class="built_in">int</span>(x0), <span class="built_in">int</span>(y0)</span><br><span class="line">p = ((y0**<span class="number">2</span> - <span class="number">4</span>*N).sqrt() + y0) / <span class="number">2</span></span><br><span class="line">q = N // p</span><br><span class="line">d = <span class="built_in">pow</span>(e, -<span class="number">1</span>, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">flag = <span class="built_in">pow</span>(ct, d, N)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(flag))</span><br><span class="line"><span class="comment"># NepCTF&#123;larg3r_M0du1u5_1nf0_g1ves_b3773r_b0und5&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="transistion">transistion</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">我们通过一个DFF串行把数据从本机传输进FPGA里然后进行能量采集。先对时钟采样来了解一下板子的基础信息，或许我们还能从中发现一些关于transition的侧信道信息……</span><br><span class="line">由于出题人疏忽，本题在第一次放出时未提供附件，在此滑跪。</span><br><span class="line">（flag格式为flag&#123;&#125;）</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="transition.zip">transition.zip</a></p>
<h4 id="解题思路-3">解题思路</h4>
<p>测试发现，一共采样了8000个数据，根据data的长度为64，推出data中的一个数据在采样中占125次，所以估计在125处附近会发生跳变，接着测试110~140的连续采样，发现在128处的采样能反映所有的跳变情况：</p>
<ul>
<li><span class="math inline">\(samples[128] \leq
0.5\)</span>，不跳变，相邻2比特是00。</li>
<li><span class="math inline">\(0.5 &lt; samples[128] \leq
2\)</span>，跳变，相邻2比特是01。</li>
<li><span class="math inline">\(2 &lt; samples[128] \leq
3\)</span>，跳变，相邻2比特是10。</li>
<li><span class="math inline">\(3 &lt;
samples[128]\)</span>，不跳变，相邻2比特是11。</li>
</ul>
<p>所以每次采样可以获取2比特信息，这样再以250为间隔采样，只需32次就能完全确定data，这也足够获取完整的flag。</p>
<h4 id="exp-3">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"><span class="keyword">from</span> scipy.io <span class="keyword">import</span> savemat,loadmat</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;nepctf31-nizx-0vvs-rjlc-pse68tvxp993.nepctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">samples = <span class="number">64</span></span><br><span class="line"><span class="comment"># sampledata = []</span></span><br><span class="line"><span class="comment"># int_sampledata = []</span></span><br><span class="line">guess = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>, <span class="number">8000</span>, <span class="number">250</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;1\n&quot;</span>)</span><br><span class="line">    position = i</span><br><span class="line">    io.sendafter(<span class="string">b&quot;&gt;&quot;</span>, (<span class="built_in">str</span>(position) + <span class="string">&quot;\n&quot;</span>).encode())</span><br><span class="line">    recv = <span class="built_in">eval</span>(io.recvline().decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;position&#125;</span>:\t&quot;</span>, recv)</span><br><span class="line">    <span class="keyword">if</span> recv &lt;= <span class="number">0.5</span>:</span><br><span class="line">        guess = guess + <span class="string">&quot;00&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0.5</span> &lt; recv &lt;= <span class="number">2</span>:</span><br><span class="line">        guess = guess + <span class="string">&quot;01&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">2</span> &lt; recv  &lt;= <span class="number">3</span>:</span><br><span class="line">        guess = guess + <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">3</span> &lt; recv:</span><br><span class="line">        guess = guess + <span class="string">&quot;11&quot;</span></span><br><span class="line">    <span class="comment"># sampledata.append(eval(recv))</span></span><br><span class="line">    <span class="comment"># int_sampledata.append(int(eval(recv)))</span></span><br><span class="line"><span class="comment"># print(sampledata)</span></span><br><span class="line"><span class="comment"># print(int_sampledata)</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">b&quot;&gt;&quot;</span>, <span class="string">b&quot;2\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">64</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> guess[i] == <span class="string">&quot;0&quot;</span>:</span><br><span class="line">        io.sendline(<span class="string">b&quot;0\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(<span class="string">b&quot;1\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(io.recvall(<span class="number">3</span>).decode())</span><br><span class="line">io.close()</span><br><span class="line"><span class="comment"># flag&#123;lt&#x27;s_tRANsiTlOn_IE@k4GE26fca40f&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="unloopshock">unloopshock</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turtle 会使用AES加密你的信息，且每一个人（每一次链接）都会使用不同的KEY，你能从turtle口中泄露你的KEY吗</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="unloopshock.zip">unloopshock.zip</a></p>
<h4 id="解题思路-4">解题思路</h4>
<p>根据提示，关注密钥拓展部分(密钥拓展函数地址为0x01BC)：</p>
<p>下图已恢复部分函数名。 <img src="/2025/07/28/NepCTF2025-Crypto-WP/1.png"></p>
<p>通过查看key_expand函数的引用，可以知道a2数组用来存放拓展密钥。第一个for循环将初始密钥复制到a2中，并在接下来的do-while循环中开始密钥拓展，如果能让do-while循环不执行那么拓展的密钥只有前16字节是初始密钥，而后面全为0字节。这样就可以根据已知明密文推出初始密钥。</p>
<p>为了让do-while循环不起作用，可以在前面的for循环结束时，通过注入错误修改变量i的值，让i足够大且i不是4的倍数，这样在进行了一些无意义的赋值后就可以直接跳出do-while循环。</p>
<p>所以在汇编中找到修改变量i的地方： <img src="/2025/07/28/NepCTF2025-Crypto-WP/3.png"> <img src="/2025/07/28/NepCTF2025-Crypto-WP/2.png"></p>
<p>可以发现是通过将i赋值给eax，在对eax加1后再赋值给i实现的i的加1。那么可以hook
<code>add eax 1</code>指令，通过随机修改eax的值来改变i的值。</p>
<h4 id="exp-4">exp</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exp.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recoverkey</span>(<span class="params">plain, cipher</span>):</span><br><span class="line">    inv_s_box = (   <span class="number">0X52</span>, <span class="number">0X09</span>, <span class="number">0X6A</span>, <span class="number">0XD5</span>, <span class="number">0X30</span>, <span class="number">0X36</span>, <span class="number">0XA5</span>, <span class="number">0X38</span>, <span class="number">0XBF</span>, <span class="number">0X40</span>, <span class="number">0XA3</span>, <span class="number">0X9E</span>, <span class="number">0X81</span>, <span class="number">0XF3</span>, <span class="number">0XD7</span>, <span class="number">0XFB</span>,</span><br><span class="line">        <span class="number">0X7C</span>, <span class="number">0XE3</span>, <span class="number">0X39</span>, <span class="number">0X82</span>, <span class="number">0X9B</span>, <span class="number">0X2F</span>, <span class="number">0XFF</span>, <span class="number">0X87</span>, <span class="number">0X34</span>, <span class="number">0X8E</span>, <span class="number">0X43</span>, <span class="number">0X44</span>, <span class="number">0XC4</span>, <span class="number">0XDE</span>, <span class="number">0XE9</span>, <span class="number">0XCB</span>,</span><br><span class="line">        <span class="number">0X54</span>, <span class="number">0X7B</span>, <span class="number">0X94</span>, <span class="number">0X32</span>, <span class="number">0XA6</span>, <span class="number">0XC2</span>, <span class="number">0X23</span>, <span class="number">0X3D</span>, <span class="number">0XEE</span>, <span class="number">0X4C</span>, <span class="number">0X95</span>, <span class="number">0X0B</span>, <span class="number">0X42</span>, <span class="number">0XFA</span>, <span class="number">0XC3</span>, <span class="number">0X4E</span>,</span><br><span class="line">        <span class="number">0X08</span>, <span class="number">0X2E</span>, <span class="number">0XA1</span>, <span class="number">0X66</span>, <span class="number">0X28</span>, <span class="number">0XD9</span>, <span class="number">0X24</span>, <span class="number">0XB2</span>, <span class="number">0X76</span>, <span class="number">0X5B</span>, <span class="number">0XA2</span>, <span class="number">0X49</span>, <span class="number">0X6D</span>, <span class="number">0X8B</span>, <span class="number">0XD1</span>, <span class="number">0X25</span>,</span><br><span class="line">        <span class="number">0X72</span>, <span class="number">0XF8</span>, <span class="number">0XF6</span>, <span class="number">0X64</span>, <span class="number">0X86</span>, <span class="number">0X68</span>, <span class="number">0X98</span>, <span class="number">0X16</span>, <span class="number">0XD4</span>, <span class="number">0XA4</span>, <span class="number">0X5C</span>, <span class="number">0XCC</span>, <span class="number">0X5D</span>, <span class="number">0X65</span>, <span class="number">0XB6</span>, <span class="number">0X92</span>,</span><br><span class="line">        <span class="number">0X6C</span>, <span class="number">0X70</span>, <span class="number">0X48</span>, <span class="number">0X50</span>, <span class="number">0XFD</span>, <span class="number">0XED</span>, <span class="number">0XB9</span>, <span class="number">0XDA</span>, <span class="number">0X5E</span>, <span class="number">0X15</span>, <span class="number">0X46</span>, <span class="number">0X57</span>, <span class="number">0XA7</span>, <span class="number">0X8D</span>, <span class="number">0X9D</span>, <span class="number">0X84</span>,</span><br><span class="line">        <span class="number">0X90</span>, <span class="number">0XD8</span>, <span class="number">0XAB</span>, <span class="number">0X00</span>, <span class="number">0X8C</span>, <span class="number">0XBC</span>, <span class="number">0XD3</span>, <span class="number">0X0A</span>, <span class="number">0XF7</span>, <span class="number">0XE4</span>, <span class="number">0X58</span>, <span class="number">0X05</span>, <span class="number">0XB8</span>, <span class="number">0XB3</span>, <span class="number">0X45</span>, <span class="number">0X06</span>,</span><br><span class="line">        <span class="number">0XD0</span>, <span class="number">0X2C</span>, <span class="number">0X1E</span>, <span class="number">0X8F</span>, <span class="number">0XCA</span>, <span class="number">0X3F</span>, <span class="number">0X0F</span>, <span class="number">0X02</span>, <span class="number">0XC1</span>, <span class="number">0XAF</span>, <span class="number">0XBD</span>, <span class="number">0X03</span>, <span class="number">0X01</span>, <span class="number">0X13</span>, <span class="number">0X8A</span>, <span class="number">0X6B</span>,</span><br><span class="line">        <span class="number">0X3A</span>, <span class="number">0X91</span>, <span class="number">0X11</span>, <span class="number">0X41</span>, <span class="number">0X4F</span>, <span class="number">0X67</span>, <span class="number">0XDC</span>, <span class="number">0XEA</span>, <span class="number">0X97</span>, <span class="number">0XF2</span>, <span class="number">0XCF</span>, <span class="number">0XCE</span>, <span class="number">0XF0</span>, <span class="number">0XB4</span>, <span class="number">0XE6</span>, <span class="number">0X73</span>,</span><br><span class="line">        <span class="number">0X96</span>, <span class="number">0XAC</span>, <span class="number">0X74</span>, <span class="number">0X22</span>, <span class="number">0XE7</span>, <span class="number">0XAD</span>, <span class="number">0X35</span>, <span class="number">0X85</span>, <span class="number">0XE2</span>, <span class="number">0XF9</span>, <span class="number">0X37</span>, <span class="number">0XE8</span>, <span class="number">0X1C</span>, <span class="number">0X75</span>, <span class="number">0XDF</span>, <span class="number">0X6E</span>,</span><br><span class="line">        <span class="number">0X47</span>, <span class="number">0XF1</span>, <span class="number">0X1A</span>, <span class="number">0X71</span>, <span class="number">0X1D</span>, <span class="number">0X29</span>, <span class="number">0XC5</span>, <span class="number">0X89</span>, <span class="number">0X6F</span>, <span class="number">0XB7</span>, <span class="number">0X62</span>, <span class="number">0X0E</span>, <span class="number">0XAA</span>, <span class="number">0X18</span>, <span class="number">0XBE</span>, <span class="number">0X1B</span>,</span><br><span class="line">        <span class="number">0XFC</span>, <span class="number">0X56</span>, <span class="number">0X3E</span>, <span class="number">0X4B</span>, <span class="number">0XC6</span>, <span class="number">0XD2</span>, <span class="number">0X79</span>, <span class="number">0X20</span>, <span class="number">0X9A</span>, <span class="number">0XDB</span>, <span class="number">0XC0</span>, <span class="number">0XFE</span>, <span class="number">0X78</span>, <span class="number">0XCD</span>, <span class="number">0X5A</span>, <span class="number">0XF4</span>,</span><br><span class="line">        <span class="number">0X1F</span>, <span class="number">0XDD</span>, <span class="number">0XA8</span>, <span class="number">0X33</span>, <span class="number">0X88</span>, <span class="number">0X07</span>, <span class="number">0XC7</span>, <span class="number">0X31</span>, <span class="number">0XB1</span>, <span class="number">0X12</span>, <span class="number">0X10</span>, <span class="number">0X59</span>, <span class="number">0X27</span>, <span class="number">0X80</span>, <span class="number">0XEC</span>, <span class="number">0X5F</span>,</span><br><span class="line">        <span class="number">0X60</span>, <span class="number">0X51</span>, <span class="number">0X7F</span>, <span class="number">0XA9</span>, <span class="number">0X19</span>, <span class="number">0XB5</span>, <span class="number">0X4A</span>, <span class="number">0X0D</span>, <span class="number">0X2D</span>, <span class="number">0XE5</span>, <span class="number">0X7A</span>, <span class="number">0X9F</span>, <span class="number">0X93</span>, <span class="number">0XC9</span>, <span class="number">0X9C</span>, <span class="number">0XEF</span>,</span><br><span class="line">        <span class="number">0XA0</span>, <span class="number">0XE0</span>, <span class="number">0X3B</span>, <span class="number">0X4D</span>, <span class="number">0XAE</span>, <span class="number">0X2A</span>, <span class="number">0XF5</span>, <span class="number">0XB0</span>, <span class="number">0XC8</span>, <span class="number">0XEB</span>, <span class="number">0XBB</span>, <span class="number">0X3C</span>, <span class="number">0X83</span>, <span class="number">0X53</span>, <span class="number">0X99</span>, <span class="number">0X61</span>,</span><br><span class="line">        <span class="number">0X17</span>, <span class="number">0X2B</span>, <span class="number">0X04</span>, <span class="number">0X7E</span>, <span class="number">0XBA</span>, <span class="number">0X77</span>, <span class="number">0XD6</span>, <span class="number">0X26</span>, <span class="number">0XE1</span>, <span class="number">0X69</span>, <span class="number">0X14</span>, <span class="number">0X63</span>, <span class="number">0X55</span>, <span class="number">0X21</span>, <span class="number">0X0C</span>, <span class="number">0X7D</span>,</span><br><span class="line">    )</span><br><span class="line">    s_box = (</span><br><span class="line">        <span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>,</span><br><span class="line">        <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">        <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>,</span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>,</span><br><span class="line">        <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>,</span><br><span class="line">        <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>,</span><br><span class="line">        <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>,</span><br><span class="line">        <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>,</span><br><span class="line">        <span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>,</span><br><span class="line">        <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>,</span><br><span class="line">        <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">        <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>,</span><br><span class="line">        <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>,</span><br><span class="line">        <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>,</span><br><span class="line">        <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">a, b</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(i^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(a, b))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_round_key</span>(<span class="params">s, k</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                s[i][j] ^= k[i][j]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sub_bytes</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                s[i][j] = s_box[s[i][j]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    xtime = <span class="keyword">lambda</span> a: (((a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1B</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">if</span> (a &amp; <span class="number">0x80</span>) <span class="keyword">else</span> (a &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mix_single_column</span>(<span class="params">a</span>):</span><br><span class="line">        t = a[<span class="number">0</span>] ^ a[<span class="number">1</span>] ^ a[<span class="number">2</span>] ^ a[<span class="number">3</span>]</span><br><span class="line">        u = a[<span class="number">0</span>]</span><br><span class="line">        a[<span class="number">0</span>] ^= t ^ xtime(a[<span class="number">0</span>] ^ a[<span class="number">1</span>])</span><br><span class="line">        a[<span class="number">1</span>] ^= t ^ xtime(a[<span class="number">1</span>] ^ a[<span class="number">2</span>])</span><br><span class="line">        a[<span class="number">2</span>] ^= t ^ xtime(a[<span class="number">2</span>] ^ a[<span class="number">3</span>])</span><br><span class="line">        a[<span class="number">3</span>] ^= t ^ xtime(a[<span class="number">3</span>] ^ u)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv_sub_bytes</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                s[i][j] = inv_s_box[s[i][j]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            mix_single_column(s[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv_shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>]</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">        s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv_mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            u = xtime(xtime(s[i][<span class="number">0</span>] ^ s[i][<span class="number">2</span>]))</span><br><span class="line">            v = xtime(xtime(s[i][<span class="number">1</span>] ^ s[i][<span class="number">3</span>]))</span><br><span class="line">            s[i][<span class="number">0</span>] ^= u</span><br><span class="line">            s[i][<span class="number">1</span>] ^= v</span><br><span class="line">            s[i][<span class="number">2</span>] ^= u</span><br><span class="line">            s[i][<span class="number">3</span>] ^= v</span><br><span class="line"></span><br><span class="line">        mix_columns(s)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes2matrix</span>(<span class="params">text</span>):</span><br><span class="line">                <span class="keyword">return</span> [<span class="built_in">list</span>(text[i:i+<span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(text), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line">    enc = bytes2matrix(cipher)</span><br><span class="line">    inv_shift_rows(enc)</span><br><span class="line">    inv_sub_bytes(enc)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        inv_mix_columns(enc)</span><br><span class="line">        inv_shift_rows(enc)</span><br><span class="line">        inv_sub_bytes(enc)</span><br><span class="line"></span><br><span class="line">    key = xor_bytes(<span class="built_in">bytes</span>(enc[<span class="number">0</span>] + enc[<span class="number">1</span>] + enc[<span class="number">2</span>] + enc[<span class="number">3</span>]), plain)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;nepctf30-tk8l-9zea-1qz3-w8rqzwa7f403.nepctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># AES_PTS = b&#x27;___HELLO_WORD___&#x27;</span></span><br><span class="line"><span class="comment"># Shocktime = 90</span></span><br><span class="line"><span class="comment"># cipher = run(AES_PTS,AES_KEY,Shocktime)  </span></span><br><span class="line"><span class="comment"># recoveredkey = recoverkey(AES_PTS, cipher)</span></span><br><span class="line"><span class="comment"># print(recoveredkey == AES_KEY)</span></span><br><span class="line">AES_PTS = <span class="string">b&#x27;___HELLO_WORD___&#x27;</span></span><br><span class="line">Shocktime = <span class="number">90</span></span><br><span class="line">io.recvuntil(<span class="string">b&quot;Input your data: in hex(max 16 bytes)\n&quot;</span>)</span><br><span class="line">io.sendline(AES_PTS.<span class="built_in">hex</span>().encode())</span><br><span class="line">io.recvuntil(<span class="string">b&quot;time to shock: &quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(Shocktime).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Result:&quot;</span>)</span><br><span class="line">cipher = <span class="built_in">bytes</span>.fromhex(io.recvline().decode().strip())</span><br><span class="line">key = recoverkey(AES_PTS, cipher)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;now give me your guess key: &quot;</span>)</span><br><span class="line">io.sendline(key.<span class="built_in">hex</span>().encode())</span><br><span class="line"><span class="built_in">print</span>(io.recvall(<span class="number">2</span>).decode())</span><br><span class="line">io.close()</span><br><span class="line"><span class="comment"># NepCTF&#123;ThE_4eS-CH1p_G3t_5HOcK3d-y0u-G3T-Th3-cRIt1Cal_kEyYYyY0&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="国产密码应用">*国产密码应用</h3>
<p><strong>题目描述</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">小明通过开源的GMSSL采用TLCP协议实现与服务端之间数据的传输机密性和完整性保护，且均采用服务器密码机实现数据加解密和签名验签的运算。但是在运行过程中似乎都出现了一些小问题，你能发现吗？（答案格式：NepCTF&#123;XXX&#125;）</span><br></pre></td></tr></table></figure>
<p><strong>题目附件</strong></p>
<p><a href="国产密码应用.zip">国产密码应用.zip</a></p>
<h4 id="解题思路-5">解题思路</h4>
<p>学了2天的TLCP，终于成功复现。</p>
<p>学习过程中主要参考了如下资料：<br>
1. <span id="ref1"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=3EE2FD47B962578070541ED468497C5B">GB/T
32918 SM2椭圆曲线公钥密码算法：总则</a></span> <a href="#cite1"></a><br>
2. <span id="ref2"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=6F1FAEB62F9668F25F38E0BF0291D4AC">GB/T
32918 SM2椭圆曲线公钥密码算法：数字签名算法</a></span> <a href="#cite2"></a><br>
3. <span id="ref3"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=66A89DD6DA64F49C49456B757BA0624F">GB/T
32918 SM2椭圆曲线公钥密码算法：密钥交互协议</a></span> <a href="#cite3"></a><br>
4. <span id="ref4"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=370AF152CB5CA4A377EB4D1B21DECAE0">GB/T
32918 SM2椭圆曲线公钥密码算法：公钥加密算法</a></span> <a href="#cite4"></a><br>
5. <span id="ref5"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=728DEA8B8BB32ACFB6EF4BF449BC3077">GB/T
32918 SM2椭圆曲线公钥密码算法：参数定义</a></span> <a href="#cite5"></a><br>
6. <span id="ref6"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=2127A9F19CB5D7F20D17D334ECA63EE5">GB/T
35276 SM2密码算法使用规范</a></span> <a href="#cite6"></a><br>
7. <span id="ref7"><a target="_blank" rel="noopener" href="https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=778097598DA2761E94A5FF3F77BD66DA">GB/T
38636 传输层密码协议（TLCP）</a></span> <a href="#cite7"></a><br>
8. <span id="ref8"><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16M4m127an">bilibili-泥瓦匠的标准解读-【GB/T
38636】TLCP协议中密钥计算（手动计算主密钥、工作密钥）</a></span> <a href="#cite8"></a><br>
9. <span id="ref9"><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1kU411Z7xw">bilibili-国密TLCP协议解析</a></span>
<a href="#cite9"></a><br>
10. <span id="ref10"><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43408952/article/details/124614727">csdn-预主密钥/主密钥计算和Finished消息的加解密</a></span>
<a href="#cite10"></a></p>
<p>使用的gmssl的python实现：<br>
11. <span id="ref11"><a target="_blank" rel="noopener" href="https://github.com/py-gmssl/py-gmssl">https://github.com/py-gmssl/py-gmssl</a></span>
<a href="#cite11"></a></p>
<h5 id="获取签名私钥">获取签名私钥</h5>
<p>TLCP的握手流程如下<a href="#ref7"><sup id="cite7">[7]</sup></a>：
<img src="/2025/07/28/NepCTF2025-Crypto-WP/handshake.png"></p>
<p>wireshark解析的流量包：（注意低版本的wireshark不能正确显示TLCP协议，这里使用的版本为4.4.8）
<img src="/2025/07/28/NepCTF2025-Crypto-WP/g1.png"></p>
<p>首先来看<code>Client Hello</code>消息： <img src="/2025/07/28/NepCTF2025-Crypto-WP/g2.png">
这里会包含一个客户端生成的随机数，我们先把他记录下来，后续生成工作密钥会用到：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CR = <span class="string">&quot;687b612b5cb1222783ee426a817d3da6a05ed985fd06dd72ff3cf58a3ffda4aa&quot;</span></span><br></pre></td></tr></table></figure></p>
<p>同样的，<code>Server Hello</code>消息也会包含一个服务端随机数，也记录下来：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SR = <span class="string">&quot;687b612bdbd4517e6fc989ddd2bf25e78b5e21e576bbd8f46add6d7df527887f&quot;</span></span><br></pre></td></tr></table></figure></p>
<p>双方在交换随机数后，服务端会发来<code>Certificate</code>消息： <img src="/2025/07/28/NepCTF2025-Crypto-WP/g3.png">
这里面包含2个证书，第1个是签名证书，第2个是加密证书。<br>
签名证书用来验证加密证书的有效性，加密证书用于后续的密钥交换。</p>
<p>签名证书的内容如下： <img src="/2025/07/28/NepCTF2025-Crypto-WP/g4.png">
其中subjectPublickey就是签名的公钥，把04的tag去掉，剩下的64字节就是公钥的横纵坐标：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">0xd401ce6a6684178fa77940108f2f8946352208b29bd6f9bda14a38ddec05668c</span></span><br><span class="line">y = <span class="number">0x71a68d1199f376f5656e0d6fa93d73196e02c95ad2b311f9c220d3139ad0ccdc</span></span><br></pre></td></tr></table></figure></p>
<p>签名值在<code>Server Key Exchange</code>消息中： <img src="/2025/07/28/NepCTF2025-Crypto-WP/signature.png"></p>
<p>按如下方式解析签名<a href="#ref6"><sup id="cite6">[6]</sup></a>：
<img src="/2025/07/28/NepCTF2025-Crypto-WP/signature_asn1.png"></p>
<p>签名值是： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r = <span class="number">0x04a361f2c6cf3e297e5e5dc73df6ffc1bd129ff6a1c0baa19b294953ce374abd</span></span><br><span class="line">s = <span class="number">0x3916042142eb8919763f7f304a48be1aaf02866e6935a30503c5d90e2f4c7927</span></span><br></pre></td></tr></table></figure></p>
<p>拿到公钥和签名后，来看签名过程<a href="#ref2"><sup id="cite2">[2]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/sign_process.png"></p>
<p>其中<span class="math inline">\(ID_A\)</span>使用默认值<a href="#ref6"><sup id="cite6">[6]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/ID_A_default.png"></p>
<p>消息<span class="math inline">\(M\)</span>由客户端随机数、服务端随机数、加密证书拼接得到。在复制加密证书的时候，一定要把表示证书长度的3字节也复制上。</p>
<p>最后，拿到数据，我们可以验证一下： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># verify.py</span></span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3</span><br><span class="line">n = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span></span><br><span class="line">p = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF</span></span><br><span class="line">g = (<span class="number">0x32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7</span>,</span><br><span class="line">     <span class="number">0xbc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0</span>)</span><br><span class="line">a = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC</span></span><br><span class="line">b = <span class="number">0x28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93</span></span><br><span class="line">E = EllipticCurve(GF(p), [a, b])</span><br><span class="line">G = E(g)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">r, s, e, PubKey</span>):</span><br><span class="line">    t = (s1 + r1) % n</span><br><span class="line">    P1 = s1 * G</span><br><span class="line">    P2 = t * PubKey</span><br><span class="line">    x = <span class="built_in">int</span>((P1 + P2).x())</span><br><span class="line">    <span class="keyword">return</span> (e1 + x - r1) % n == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">ENTL_A = <span class="string">b&quot;\x00\x80&quot;</span></span><br><span class="line">ID_A = <span class="string">b&quot;1234567812345678&quot;</span></span><br><span class="line">a_byte = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(a)[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">b_byte = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(b)[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">xG = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(<span class="built_in">int</span>(G.x()))[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">yG = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(<span class="built_in">int</span>(G.y()))[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">PK = E(<span class="number">0xd401ce6a6684178fa77940108f2f8946352208b29bd6f9bda14a38ddec05668c</span>, <span class="number">0x71a68d1199f376f5656e0d6fa93d73196e02c95ad2b311f9c220d3139ad0ccdc</span>)</span><br><span class="line">CER = <span class="string">&quot;0001dd308201d93082017fa003020102020c5d4a7a54c074b6550ae82dd4300a06082a811ccf550183753066310b300906035504061302434e3111300f0603550408130850524f56494e43453111300f060355040713084c4f43414c495459310c300a060355040a13034f52473110300e060355040b13074f524755494e543111300f060355040313084e65704e65704341301e170d3235303731333035313231345a170d3335303731313035313231345a3067310b300906035504061302434e3111300f0603550408130850524f56494e43453111300f060355040713084c4f43414c495459310c300a060355040a13034f52473110300e060355040b13074f524755494e5431123010060355040313094e65704e6570456e633059301306072a8648ce3d020106082a811ccf5501822d03420004b1e942c2068b9312f82cf22b5c01f4910e49e10408478c03ad9c5e37013852212f90f0d88d7e2ca86bb718772b213e757d0e6ca505444d19d5496c9a70323d46a3123010300e0603551d0f0101ff040403020520300a06082a811ccf55018375034800304502206671281fe2bf53d3c596132fe5a58101ec805566b5b76a5ac7b549fe5e4805c5022100cf148ffa42395c3a60cf103953fcf728d566080fced186c9191fef9b5f81e081&quot;</span></span><br><span class="line">xA = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(<span class="built_in">int</span>(PK.x()))[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">yA = <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(<span class="built_in">int</span>(PK.y()))[<span class="number">2</span>:].zfill(<span class="number">64</span>))</span><br><span class="line">ZA = sm3.sm3_hash(<span class="built_in">list</span>(ENTL_A + ID_A + a_byte + b_byte + xG + yG + xA + yA))</span><br><span class="line"></span><br><span class="line">CR = <span class="string">&quot;687b612b5cb1222783ee426a817d3da6a05ed985fd06dd72ff3cf58a3ffda4aa&quot;</span></span><br><span class="line">SR = <span class="string">&quot;687b612bdbd4517e6fc989ddd2bf25e78b5e21e576bbd8f46add6d7df527887f&quot;</span></span><br><span class="line">r1 = <span class="number">0x04a361f2c6cf3e297e5e5dc73df6ffc1bd129ff6a1c0baa19b294953ce374abd</span></span><br><span class="line">s1 = <span class="number">0x3916042142eb8919763f7f304a48be1aaf02866e6935a30503c5d90e2f4c7927</span></span><br><span class="line">M = ZA + CR + SR + CER</span><br><span class="line">M = <span class="built_in">bytes</span>.fromhex(M)</span><br><span class="line">e1 = <span class="built_in">int</span>(sm3.sm3_hash(<span class="built_in">list</span>(M)), <span class="number">16</span>)</span><br><span class="line"><span class="keyword">assert</span> verify(r1, s1, e1, PK)</span><br></pre></td></tr></table></figure></p>
<p>同样的，我们还可以获取第二个通信的签名，然后根据题目提示的随机数复用（随机数复用这一点，也可以通过比对两次签名的<span class="math inline">\((r - e) \mod
n\)</span>值来发现），只需要解一个线性方程组来恢复签名的私钥：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get_sign_prikey.py</span></span><br><span class="line">n = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sollin</span>(<span class="params">r1, s1, r2, s2</span>):</span><br><span class="line">    k, d = var(<span class="string">&quot;k d&quot;</span>)</span><br><span class="line">    f1 = (<span class="number">1</span> + d) * s1 - k + r1 * d</span><br><span class="line">    f2 = (<span class="number">1</span> + d) * s2 - k + r2 * d</span><br><span class="line">    fd = f1.resultant(f2, k)</span><br><span class="line">    fk = f1.resultant(f2, d)</span><br><span class="line">    PR.&lt;d&gt; = PolynomialRing(GF(n))</span><br><span class="line">    fd = PR(<span class="built_in">str</span>(fd))</span><br><span class="line">    d = <span class="built_in">int</span>(fd.roots()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    PR.&lt;k&gt; = PolynomialRing(GF(n))</span><br><span class="line">    fk = PR(<span class="built_in">str</span>(fk))</span><br><span class="line">    k = <span class="built_in">int</span>(fk.roots()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> k, d</span><br><span class="line">r1 = <span class="number">0x04a361f2c6cf3e297e5e5dc73df6ffc1bd129ff6a1c0baa19b294953ce374abd</span></span><br><span class="line">s1 = <span class="number">0x3916042142eb8919763f7f304a48be1aaf02866e6935a30503c5d90e2f4c7927</span></span><br><span class="line">r2 = <span class="number">0x604b0232ee0907c6957c1521457ff2ab5bb32a7637221eec88c0e7fba6fc4b12</span></span><br><span class="line">s2 = <span class="number">0x6c0e3e59b46bb87abf7c9c7398bc75bec795e85e92c2414770772ea32a0b8205</span></span><br><span class="line">k, d = sollin(r1, s1, r2, s2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;d = &#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d = <span class="number">56431408153695370061795421010209097251225434679562598847096735820032467303653</span></span><br></pre></td></tr></table></figure></p>
<h5 id="解密通信流量">解密通信流量</h5>
<p>首先需要获取预主密钥（48字节），前2字节是0x0101（客户端所支持的版本号），后46字节是随机数。预主密钥由客户端生成，并在<code>Client Key Exchange</code>消息中通过加密证书加密传输。
<img src="/2025/07/28/NepCTF2025-Crypto-WP/client_key_exchange.png"></p>
<p>密文可以按如下结构解析<a href="#ref6"><sup id="cite6">[6]</sup></a>：
<img src="/2025/07/28/NepCTF2025-Crypto-WP/cipher_structure.png"> 得到： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">0x00c749061668652e26040e008fdd5eb77a344a417b7fce19dba575da57cc372a9e</span></span><br><span class="line">y = <span class="number">0x00f2df5db2d144e9454504c622b51cf38f5006206eb579ff7da6976eff5fbe6480</span></span><br><span class="line">h = <span class="string">&quot;d682849ee64d092a590e0a981d750a608e59d08fdc9511426aa90b99e7c215c7&quot;</span></span><br><span class="line">c = <span class="string">&quot;67ec55ae9437abdf46ee8a1406a3356c2123b598d92a2980d7dab8ec1a51fb9d7c987b2f7d16dcf9da95ea2c86875191&quot;</span></span><br></pre></td></tr></table></figure>
通过与数据库表中加密信息的x，y值比对，能够发现与第4条加密信息用了同样的随机数。
SM2的加密方法，可以直接查看gmssl的python实现<a href="#ref11"><sup id="cite11">[11]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/SM2_encrypto.png">
可以发现，当使用相同的随机数时，最终生成的异或密钥也会相同，这样就可以通过数据库中已知的明密文，获取异或密钥，然后解密上面的密文获得预主密钥。
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([i ^ j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)])</span><br><span class="line">db_plain = <span class="string">&quot;4e475132595451784e7a6b305a5455314d7a5532597a597a4e44637a4e545a6a4e6a4d304e54526c4e5455314d6a&quot;</span></span><br><span class="line">db_cipher = <span class="string">&quot;28AA2529E18960E93052D856ED1D1476B19FE04367EDAAD6E2F177AD7DE0F9B04B2C8C98EAC83397DA0CDEB7E281&quot;</span></span><br><span class="line">db_plain = <span class="built_in">bytes</span>.fromhex(db_plain)</span><br><span class="line">db_cipher = <span class="built_in">bytes</span>.fromhex(db_cipher)</span><br><span class="line">xor_key = <span class="built_in">bytes</span>([i^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(db_plain, db_cipher)])</span><br><span class="line"></span><br><span class="line">enc_pre_secret = <span class="string">&quot;67ec55ae9437abdf46ee8a1406a3356c2123b598d92a2980d7dab8ec1a51fb9d7c987b2f7d16dcf9da95ea2c86875191&quot;</span></span><br><span class="line">enc_pre_secret = <span class="built_in">bytes</span>.fromhex(enc_pre_secret)</span><br><span class="line">pre_secret_prefix = xor_bytes(enc_pre_secret, xor_key)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(pre_secret_prefix) == <span class="number">46</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pre_secret_prefix.<span class="built_in">hex</span>())</span><br><span class="line"><span class="comment"># 010121b52cea9a4e38c63972b1ea742bddc600e9e7bdda2c7b6fac3b29e5584779deba87d98abd024ecd61aa296c</span></span><br></pre></td></tr></table></figure>
可以发现，前面2字节是0x0101（协议的版本号），说明解密是正确的。</p>
<p>由于数据库中已知明密文长度都是46字节，所以我们只拿到了预主密钥的前46字节，还需要爆破2字节。</p>
<p>拿到预主密钥后，根据如下方法生成主密钥<a href="#ref7"><sup id="cite7">[7]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/master-secret.png"></p>
<p>PRF函数定义如下<a href="#ref7"><sup id="cite7">[7]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/PRF.png"></p>
<p>获取到主密钥后，再获取工作密钥<a href="#ref7"><sup id="cite7">[7]</sup></a>： <img src="/2025/07/28/NepCTF2025-Crypto-WP/work_secret.png"> 这些密钥长度分别是32、32、16、16、16、16。</p>
<p>在双方成功获取到工作密钥后，都会发送一个<code>Finished</code>消息，在wireshark中显示为<code>Encrypted Handshake Message</code>：
<img src="/2025/07/28/NepCTF2025-Crypto-WP/Finished.png"></p>
<p>我们先来看客户端发送的这个消息，长度80字节（16字节IV+cipher（16字节finished消息明文+32字节MAC+16字节的padding））<a href="#ref10"><sup id="cite10">[10]</sup></a>： <figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f1de37c49eda363496b66f93d2c8536573e9099388cdf94e3b32c04cc091cbf79c85e78a9036f5d504a37fcf16150f368f8f78bf1ce45a0e198d58b21aaf587f2b060fb603b4d51b59de367a7587e04d</span><br></pre></td></tr></table></figure></p>
<p>解析得： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iv = <span class="string">&quot;f1de37c49eda363496b66f93d2c85365&quot;</span></span><br><span class="line">finished_cipher = <span class="string">&quot;73e9099388cdf94e3b32c04cc091cbf7&quot;</span></span><br><span class="line">mac_cipher = <span class="string">&quot;9c85e78a9036f5d504a37fcf16150f368f8f78bf1ce45a0e198d58b21aaf587f&quot;</span></span><br><span class="line">padding_cipher = <span class="string">&quot;2b060fb603b4d51b59de367a7587e04d&quot;</span></span><br></pre></td></tr></table></figure>
由于finished消息前4字节一定是0x1400000C，所以可已用来爆破前面未知的预主密钥：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># brute_pre_secret.py</span></span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm2, sm3, sm4</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SM3</span>(<span class="params">msg: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(sm3.sm3_hash(<span class="built_in">list</span>(msg)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HMAC</span>(<span class="params">key: <span class="built_in">bytes</span>, message: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        key = key.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(message, <span class="built_in">str</span>):</span><br><span class="line">        message = message.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    block_size = <span class="number">64</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(key) &gt; block_size:</span><br><span class="line">        key = <span class="built_in">bytes</span>.fromhex(sm3.sm3_hash(<span class="built_in">list</span>(key)))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(key) &lt; block_size:</span><br><span class="line">        key += <span class="string">b&#x27;\x00&#x27;</span> * (block_size - <span class="built_in">len</span>(key))</span><br><span class="line">    </span><br><span class="line">    ipad = <span class="string">b&#x27;\x36&#x27;</span> * block_size</span><br><span class="line">    opad = <span class="string">b&#x27;\x5c&#x27;</span> * block_size</span><br><span class="line">    </span><br><span class="line">    inner_key = <span class="built_in">bytes</span>([k ^ i <span class="keyword">for</span> k, i <span class="keyword">in</span> <span class="built_in">zip</span>(key, ipad)])</span><br><span class="line">    inner_data = inner_key + message</span><br><span class="line">    inner_hash = sm3.sm3_hash(<span class="built_in">list</span>(inner_data))</span><br><span class="line">    </span><br><span class="line">    outer_key = <span class="built_in">bytes</span>([k ^ o <span class="keyword">for</span> k, o <span class="keyword">in</span> <span class="built_in">zip</span>(key, opad)])</span><br><span class="line">    outer_data = outer_key + <span class="built_in">bytes</span>.fromhex(inner_hash)</span><br><span class="line">    outer_hash = sm3.sm3_hash(<span class="built_in">list</span>(outer_data))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(outer_hash)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">P_hash</span>(<span class="params">secret: <span class="built_in">bytes</span>, seed: <span class="built_in">bytes</span>, <span class="built_in">len</span>: <span class="built_in">int</span></span>):</span><br><span class="line">    A = seed</span><br><span class="line">    result = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span> // <span class="number">32</span>):</span><br><span class="line">        A = HMAC(secret, A)</span><br><span class="line">        result += HMAC(secret, A + seed)</span><br><span class="line">    A = HMAC(secret, A)</span><br><span class="line">    result += HMAC(secret, A + seed)[:<span class="built_in">len</span> % <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PRF</span>(<span class="params">secret, label, seed, <span class="built_in">len</span></span>):</span><br><span class="line">    <span class="keyword">return</span> P_hash(secret, label + seed, <span class="built_in">len</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_bytes</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([i ^ j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)])</span><br><span class="line"></span><br><span class="line">db_plain = <span class="string">&quot;4e475132595451784e7a6b305a5455314d7a5532597a597a4e44637a4e545a6a4e6a4d304e54526c4e5455314d6a&quot;</span></span><br><span class="line">db_cipher = <span class="string">&quot;28AA2529E18960E93052D856ED1D1476B19FE04367EDAAD6E2F177AD7DE0F9B04B2C8C98EAC83397DA0CDEB7E281&quot;</span></span><br><span class="line">db_plain = <span class="built_in">bytes</span>.fromhex(db_plain)</span><br><span class="line">db_cipher = <span class="built_in">bytes</span>.fromhex(db_cipher)</span><br><span class="line">xor_key = <span class="built_in">bytes</span>([i^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(db_plain, db_cipher)])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;xor_key = &#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">CR = <span class="string">&quot;687b612b5cb1222783ee426a817d3da6a05ed985fd06dd72ff3cf58a3ffda4aa&quot;</span></span><br><span class="line">SR = <span class="string">&quot;687b612bdbd4517e6fc989ddd2bf25e78b5e21e576bbd8f46add6d7df527887f&quot;</span></span><br><span class="line">CR = <span class="built_in">bytes</span>.fromhex(CR)</span><br><span class="line">SR = <span class="built_in">bytes</span>.fromhex(SR)</span><br><span class="line"></span><br><span class="line">enc_pre_secret = <span class="string">&quot;67ec55ae9437abdf46ee8a1406a3356c2123b598d92a2980d7dab8ec1a51fb9d7c987b2f7d16dcf9da95ea2c86875191&quot;</span></span><br><span class="line">enc_pre_secret = <span class="built_in">bytes</span>.fromhex(enc_pre_secret)</span><br><span class="line">pre_secret_prefix = xor_bytes(enc_pre_secret, xor_key)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(pre_secret_prefix) == <span class="number">46</span></span><br><span class="line"></span><br><span class="line">iv = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;f1de37c49eda363496b66f93d2c85365&quot;</span>)</span><br><span class="line">c = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;73e9099388cdf94e3b32c04cc091cbf7&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">256</span> * <span class="number">256</span> - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">    pre_secret = pre_secret_prefix + <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(i)[<span class="number">2</span>:].zfill(<span class="number">4</span>))</span><br><span class="line">    master_secret = PRF(pre_secret, <span class="string">b&quot;master secret&quot;</span>, CR + SR, <span class="number">48</span>)</span><br><span class="line">    ALL_KEY = PRF(master_secret, <span class="string">b&quot;key expansion&quot;</span>, SR + CR, <span class="number">80</span>)</span><br><span class="line">    ck = ALL_KEY[<span class="number">64</span>: <span class="number">64</span> + <span class="number">16</span>]</span><br><span class="line">    SM4 = sm4.CryptSM4()</span><br><span class="line">    SM4.set_key(ck, sm4.SM4_DECRYPT)</span><br><span class="line">    pt = SM4.crypt_cbc(iv, c)</span><br><span class="line">    <span class="keyword">if</span> pt[:<span class="number">4</span>] == <span class="string">b&quot;\x14\x00\x00\x0c&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pre_secret = &#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># pre_secret = b&#x27;\x01\x01!\xb5,\xea\x9aN8\xc69r\xb1\xeat+\xdd\xc6\x00\xe9\xe7\xbd\xda,&#123;o\xac;)\xe5XGy\xde\xba\x87\xd9\x8a\xbd\x02N\xcda\xaa)l\xf7B&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p>拿到预主密钥后，再按照上面的方法，生成工作密钥，就可以解密<code>Application Data</code>消息中的密文了。</p>
<h5 id="最后的sm2">最后的SM2</h5>
<p>拿到工作密钥后，我解密了第一个<code>Application Data</code>中的密文，解密结果为：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;\xb3K\x9a\xe3z\x124Y&#123;\xf2\x9a^[\xa5ck308189022100D41161C94F626297DB5CAE9D1B1ABC1C6363064DA2D82C48F0DDF7F8B98966D102204AEC64B7742E5C014665BCB9BD1AEFB4BE973854929DA50F23B583D2CC283DD90420F19E80E48A53140E33178DC48F9195E6D87463608464E64AF47C0DF58A3B083104208D4C762D5BAF59B6787B11DB97A4129B44CEE3BE7782D5A35A7FA57F59089089\n\x90)\xd7\x00\x05\x1fe\xc7\x9d\xb8\xea\xddcG)\xc4\xee\x81\xcf\x18\xf5\xeb\xf5\xea\x8a\xc9g\xee\x18\xd5O\xc6\x06\x06\x06\x06\x06\x06\x06&#x27;</span></span><br><span class="line"><span class="string">b&#x27;b\xf5\xdc#\x91\xcbEL\xe0\xf0$\xd72H\x07\xd33081AA02201169369B36F4266E9A86007020B8917DEE190E7F3323BA889FE4FD9423EB39CE02210099ADDE8DC3128E6FE4521A2E1740AD73A570FB7F5D289435E71E47218BEC28010420957B7D29A5734EB548E03E5E0A4A2CA87CE493D5E6908503D7D36881C71F09A30441B111A30786E760723E744718DF10E4E33CA0D7003FB7A0A4EE37226586D2F7B7A3BB9A8D35134C39192B3735FA76C3562CC3E3E158F40ED83BBF321387B8A65848\n\xbc\xd5A\xcd\x7f@Rh\x81\x99\xeaK\x9a\xfe\x02\xea\xc9\x8f\x8b\xb2\xf3\xee\x80\x1b[ZG\xc4\xaa\xf8?\xec\x04\x04\x04\x04\x04&#x27;</span></span><br><span class="line"><span class="string">b&#x27;t\xc1\xe6[\xcbY\x94NH\xf1\xdb\x8d\xcc\xb0\x97\xf330819202203F271466AE70B4B61C660B3E727BAB30FA988751F771F4380E3ED95A706979CC022100D23C2B2662E8AFA757F136B47116DB9F52A05EF2FD7F7326D08FE113B9E9EA79042061D6AFB6D97BD62119D3E90527A093AEE6A059A015B20960BF7574F1CAA39D4C0429FB2E3155BA0383D07CFE0D866E73DBB890B2DA037F07BA5D2A0D7E2CDAAECEF91DD4E169DB8412245C\n\x9e\xd3\xa2\xb9\x06\xbb\x0f\xd5o\xdb\x03\xee\x93\x84\x00\x8a\xc4\x98\x1d]q\x87?\x96f\xa8\rvH\x1b\xfa\xba\x04\x04\x04\x04\x04&#x27;</span></span><br><span class="line"><span class="string">b&quot;v\xf7\xc0O\xd9\x14\xb5\x08&#x27;\x17j\xe9\x89\xcc\x8b`308199022100C749061668652E26040E008FDD5EB77A344A417B7FCE19DBA575DA57CC372A9E022100F2DF5DB2D144E9454504C622B51CF38F5006206EB579FF7DA6976EFF5FBE64800420CD0DF57ACF39667C8E3BD5C16B9381DEAB56A2CE696A3ACE83E4D189AD98964A042F51D4412F8CBF06F3494D8500D32F70229FD381170BA690CD9BD376B55580C6E33523F79D9DA9519FF668EFB29888AC\n\x13\n\x1f\xdfjGh\xfc\x89Q\x9ez2\x0eD\xd5\xc0LC\xee\xe0\xed\xb6W\xa9\xde\x9c\x08)\x08\xe6\xc8\x06\x06\x06\x06\x06\x06\x06&quot;</span></span><br></pre></td></tr></table></figure>
可以发现中间又套了一个SM2密文。同样的，和数据库表中的密文比对一下数据，发现用的随机数也是一样的，所以和上面一样的套路，都可以解密。解密的结果和数据库表中的明文也是一样的。</p>
<p>唯一不同的是最后一次TLCP通信，里面的<code>Application Data</code>消息解密后剩下的SM2密文，没法在数据库表中找到对应密钥，所以没法解密。这个时候我又去问了问出题人，了解到了最后一次SM2加密的随机数，其实用的是前面签名证书的私钥，知道了这一点后，就很快解密了数据，成功拿到flag。
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># final.py</span></span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3</span><br><span class="line">n = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span></span><br><span class="line">p = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF</span></span><br><span class="line">a = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC</span></span><br><span class="line">b = <span class="number">0x28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93</span></span><br><span class="line">E = EllipticCurve(GF(p), [a, b])</span><br><span class="line">d = <span class="number">56431408153695370061795421010209097251225434679562598847096735820032467303653</span></span><br><span class="line">x = <span class="number">0xde11a990ff68085d48d482ebc43f69806843810d57e89b348e052406d33ec1c2</span></span><br><span class="line">y = <span class="number">0x197f651f724edd26b43f283569c117b8586d2e0278f8b1fbb64f9247e08d0ca7</span></span><br><span class="line">cipher = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;8ffd6249f3e6733945100a05b0893e2d9290173f1101c3b2f0a7eb618464d2b594ea09f5&quot;</span>)</span><br><span class="line">PK = E((x, y))</span><br><span class="line">S = d * PK</span><br><span class="line">Sx = <span class="built_in">hex</span>(<span class="built_in">int</span>(S.x()))[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">Sy = <span class="built_in">hex</span>(<span class="built_in">int</span>(S.y()))[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br><span class="line">t = <span class="built_in">bytes</span>.fromhex(sm3.sm3_kdf((Sx + Sy).encode(), <span class="built_in">len</span>(cipher)))</span><br><span class="line">flag = <span class="built_in">bytes</span>([i^^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(t, cipher)])</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure> <figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NepCTF&#123;Y0u_A1e_900D_at_TLCP_And_SM_A1g0r1tm&#125;</span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>FariTree
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/2025/07/28/NepCTF2025-Crypto-WP/" title="NepCTF2025-Crypto-WP">http://example.com/2025/07/28/NepCTF2025-Crypto-WP/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"><i class="fa fa-tag"></i> CTF</a>
              <a href="/tags/%E4%BE%A7%E4%BF%A1%E9%81%93/" rel="tag"><i class="fa fa-tag"></i> 侧信道</a>
              <a href="/tags/HNP/" rel="tag"><i class="fa fa-tag"></i> HNP</a>
              <a href="/tags/GMSSL/" rel="tag"><i class="fa fa-tag"></i> GMSSL</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/08/2025OpenHarmonyCTF-Crypto-WP/" rel="prev" title="2025OpenHarmonyCTF-Crypto-WP">
                  <i class="fa fa-angle-left"></i> 2025OpenHarmonyCTF-Crypto-WP
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">FariTree</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>





</body>
</html>
